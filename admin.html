<!DOCTYPE html>
<!-- Version: 4.0.0 - Updated: 2026-02-07 | DBA2 Final Project - Modern Admin Panel -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Panel - LokAlert</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" crossorigin="anonymous">
    <style>
        /* ============================================
           CSS VARIABLES
           ============================================ */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #22d3ee;
            --bg-body: #0c0f1a;
            --bg-sidebar: #111427;
            --bg-card: #171a2e;
            --bg-card-hover: #1e2140;
            --bg-input: #1c1f36;
            --text: #e2e8f0;
            --text-muted: #6b7294;
            --text-heading: #f1f5f9;
            --border: #252a40;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --sidebar-w: 260px;
            --header-h: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ============================================
           LOGIN PAGE
           ============================================ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: radial-gradient(ellipse at 50% 0%, rgba(99,102,241,.12) 0%, transparent 60%);
        }
        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 60px -12px rgba(0,0,0,.6);
        }
        .login-logo { text-align: center; margin-bottom: 36px; }
        .login-logo .icon { font-size: 44px; margin-bottom: 12px; }
        .login-logo h1 {
            font-size: 24px; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .login-logo p { color: var(--text-muted); margin-top: 6px; font-size: 14px; }
        .login-container.hidden { display: none; }

        /* Invite Acceptance Form */
        .invite-box { max-width: 440px; }
        .invite-badge { display: inline-block; background: rgba(34,197,94,.1); color: var(--success); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 16px; }

        /* ============================================
           FORMS & INPUTS (global)
           ============================================ */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; margin-bottom: 6px;
            color: var(--text-muted); font-size: 13px; font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 11px 14px;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); font-size: 14px;
            font-family: inherit; transition: border .2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99,102,241,.15);
        }
        textarea { resize: vertical; min-height: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 10px 0; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all .2s; border: none; text-decoration: none;
            font-family: inherit;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-danger:hover { opacity: .9; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-success:hover { opacity: .9; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-warning:hover { opacity: .9; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
        .btn-sm { padding: 6px 14px; font-size: 13px; border-radius: 8px; }
        .btn-lg { padding: 14px 28px; font-size: 16px; width: 100%; }
        .btn-icon { padding: 6px; width: 32px; height: 32px; border-radius: 8px; }
        .btn-small { padding: 6px 14px; font-size: 13px; border-radius: 8px; }

        .error-msg {
            background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.3);
            color: var(--danger); padding: 12px; border-radius: 10px;
            margin-bottom: 20px; text-align: center; display: none; font-size: 14px;
        }

        /* Password Requirements Checklist */
        .pw-requirements {
            list-style: none; padding: 0; margin: 8px 0 0;
            font-size: 0.8rem; color: #94a3b8;
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px;
        }
        .pw-requirements li {
            position: relative; padding-left: 20px; transition: color 0.2s;
        }
        .pw-requirements li::before {
            content: '‚óã'; position: absolute; left: 0;
            font-size: 0.75rem; line-height: 1.4;
        }
        .pw-requirements li.met { color: #22c55e; }
        .pw-requirements li.met::before { content: '‚úì'; font-weight: 700; }
        .pw-requirements li.unmet { color: #ef4444; }
        .pw-requirements li.unmet::before { content: '‚úó'; font-weight: 700; }

        .back-link { display: block; text-align: center; margin-top: 24px; color: var(--text-muted); text-decoration: none; font-size: 13px; }
        .back-link:hover { color: var(--primary); }

        /* ============================================
           DASHBOARD SHELL (sidebar + topbar + content)
           ============================================ */
        .dashboard { display: none; }
        .dashboard.active { display: flex; min-height: 100vh; }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            position: fixed; top: 0; left: 0; bottom: 0;
            z-index: 200; transition: transform .3s ease;
        }
        .sidebar-brand {
            height: var(--header-h); display: flex; align-items: center;
            gap: 10px; padding: 0 20px;
            border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .sidebar-brand .logo-icon { font-size: 26px; }
        .sidebar-brand h2 {
            font-size: 17px; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 16px 12px; }
        .sidebar-nav-label {
            font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px;
            color: var(--text-muted); padding: 14px 12px 6px; font-weight: 600;
        }
        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; border-radius: 10px;
            color: var(--text-muted); font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all .15s; margin-bottom: 2px;
            user-select: none;
        }
        .nav-item:hover { background: rgba(99,102,241,.08); color: var(--text); }
        .nav-item.active { background: rgba(99,102,241,.14); color: var(--primary-light); font-weight: 600; }
        .nav-item .nav-icon { font-size: 18px; width: 24px; text-align: center; flex-shrink: 0; }
        .nav-item .nav-badge {
            margin-left: auto; background: var(--primary); color: #fff;
            font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
        }
        .sidebar-footer {
            padding: 16px 20px; border-top: 1px solid var(--border);
            font-size: 12px; color: var(--text-muted); flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* --- Top bar --- */
        .topbar {
            height: var(--header-h); background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 28px; position: sticky; top: 0; z-index: 100;
        }
        .topbar-left { display: flex; align-items: center; gap: 16px; }
        .topbar-left .page-title { font-size: 16px; font-weight: 600; color: var(--text-heading); }
        .topbar-right { display: flex; align-items: center; gap: 14px; }
        .hamburger {
            display: none; background: none; border: none; color: var(--text);
            font-size: 22px; cursor: pointer; padding: 4px;
        }

        /* Maintenance banner */
        .maintenance-banner {
            background: linear-gradient(90deg, rgba(245,158,11,.15), rgba(239,68,68,.15));
            border-bottom: 1px solid rgba(245,158,11,.3);
            padding: 8px 20px; text-align: center; font-size: 13px; font-weight: 600;
            color: var(--warning); display: none;
        }
        .maintenance-banner.active { display: block; }

        /* Session timer */
        .session-timer {
            display: flex; align-items: center; gap: 5px;
            font-size: 12px; color: var(--text-muted);
            padding: 5px 10px; background: rgba(255,255,255,.04);
            border-radius: 8px; border: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
        }
        .session-timer.warning { color: var(--warning); border-color: rgba(245,158,11,.4); }
        .session-timer.danger { color: var(--danger); border-color: rgba(239,68,68,.4); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

        .admin-badge {
            display: flex; align-items: center; gap: 8px;
            font-size: 13px; color: var(--text);
        }
        .admin-badge .avatar {
            width: 32px; height: 32px; border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 13px; color: #fff;
        }
        .btn-logout-sm {
            background: none; border: 1px solid var(--border); color: var(--text-muted);
            padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 13px;
            transition: all .2s; font-family: inherit;
        }
        .btn-logout-sm:hover { border-color: var(--danger); color: var(--danger); }

        /* --- Main content area --- */
        .main-wrap {
            margin-left: var(--sidebar-w); flex: 1;
            display: flex; flex-direction: column; min-height: 100vh;
        }
        .main-content { padding: 28px; flex: 1; max-width: 1400px; }

        /* Page sections (only one visible at a time) */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeUp .25s ease; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           CARDS & COMMON COMPONENTS
           ============================================ */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 24px; margin-bottom: 24px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .card-header h2 { font-size: 16px; font-weight: 600; color: var(--text-heading); display: flex; align-items: center; gap: 8px; }
        .card-header h3 { font-size: 15px; font-weight: 600; color: var(--text-heading); }

        /* Stats grid */
        .stats-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 20px; position: relative; overflow: hidden;
            transition: transform .15s, box-shadow .15s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.2); }
        .stat-card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
        }
        .stat-card.c1::after { background: var(--primary); }
        .stat-card.c2::after { background: var(--secondary); }
        .stat-card.c3::after { background: var(--success); }
        .stat-card.c4::after { background: var(--warning); }
        .stat-card.c5::after { background: #a78bfa; }
        .stat-card .stat-icon { font-size: 28px; margin-bottom: 10px; }
        .stat-card .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; color: var(--text-heading); }

        /* Tables */
        .table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        th { color: var(--text-muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; background: rgba(255,255,255,.02); white-space: nowrap; }
        tbody tr { transition: background .1s; }
        tbody tr:hover { background: rgba(99,102,241,.04); }
        tbody tr:last-child td { border-bottom: none; }
        .table-container { overflow-x: auto; }

        .badge {
            display: inline-block; padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
        }
        .badge-success { background: rgba(34,197,94,.12); color: var(--success); }
        .badge-primary { background: rgba(99,102,241,.12); color: var(--primary-light); }
        .badge-warning { background: rgba(245,158,11,.12); color: var(--warning); }
        .badge-danger { background: rgba(239,68,68,.12); color: var(--danger); }

        .actions { display: flex; gap: 6px; }

        /* Clickable table rows (database browser) */
        .table-clickable .table-name {
            color: var(--primary-light); font-weight: 600; cursor: pointer;
            text-decoration: none; transition: color .15s;
        }
        .table-clickable .table-name:hover { color: var(--secondary); text-decoration: underline; }

        /* Alert toasts */
        #alertContainer { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .alert {
            padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 500;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,.35); animation: slideIn .25s ease;
            max-width: 420px; pointer-events: auto;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .alert-success { background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.3); color: var(--success); }
        .alert-error { background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.3); color: var(--danger); }

        /* Empty state */
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 56px; margin-bottom: 16px; opacity: .4; }

        /* ============================================
           MODALS
           ============================================ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,.75); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px; max-width: 500px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0,0,0,.5);
        }
        .modal-content h3 { margin-bottom: 16px; font-size: 18px; color: var(--text-heading); }
        .modal-large { max-width: 95vw; width: 1200px; }

        /* Browser toolbar */
        .browser-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .browser-pagination { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .browser-pagination button {
            padding: 5px 10px; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text); border-radius: 6px; cursor: pointer; font-size: 12px; transition: all .15s;
        }
        .browser-pagination button:hover { background: var(--primary); border-color: var(--primary); }
        .data-table { font-size: 12px; }
        .data-table td { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table td:hover { white-space: normal; word-break: break-all; }
        .data-cell-null { color: var(--text-muted); font-style: italic; }

        /* ============================================
           SECTION-SPECIFIC: Dashboard
           ============================================ */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        .mini-stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .mini-stat {
            background: var(--bg-input); padding: 14px; border-radius: 10px; text-align: center;
        }
        .mini-stat .ms-val { font-size: 20px; font-weight: 700; }
        .mini-stat .ms-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        /* ============================================
           SECTION-SPECIFIC: Backups
           ============================================ */
        .backup-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 14px; margin-bottom: 24px;
        }
        .backup-action {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; text-align: center;
            cursor: pointer; transition: all .2s;
        }
        .backup-action:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 8px 30px rgba(99,102,241,.12); }
        .backup-action .ba-icon { font-size: 34px; margin-bottom: 10px; }
        .backup-action .ba-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: var(--text-heading); }
        .backup-action .ba-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }

        /* ============================================
           SECTION-SPECIFIC: Settings
           ============================================ */
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 14px;
        }
        .setting-item {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 10px; padding: 18px;
        }
        .setting-item input, .setting-item select {
            width: 100%; padding: 9px 12px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-size: 14px; margin-top: 8px; font-family: inherit;
        }
        .setting-item input:focus, .setting-item select:focus { outline: none; border-color: var(--primary); }
        .setting-item textarea {
            width: 100%; padding: 9px 12px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-size: 14px; margin-top: 8px; font-family: inherit;
            resize: vertical; min-height: 60px;
        }

        /* Info box */
        .info-box {
            background: rgba(255,255,255,.02); border-radius: 10px; padding: 14px 16px;
            margin-top: 16px; font-size: 13px; color: var(--text-muted); line-height: 1.6;
        }
        .info-box strong { color: var(--text); }

        /* Invite card */
        .invite-card {
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .invite-card .invite-info { flex: 1; min-width: 200px; }
        .invite-link-box {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            padding: 10px 14px; font-family: monospace; font-size: 12px; color: var(--primary-light);
            word-break: break-all; margin-top: 10px; cursor: pointer;
        }
        .invite-link-box:hover { border-color: var(--primary); }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 900px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 10px 0 40px rgba(0,0,0,.5); }
            .main-wrap { margin-left: 0; }
            .hamburger { display: block; }
            .stats-row { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            .form-row { grid-template-columns: 1fr; }
            .dash-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .main-content { padding: 16px; }
            .card { padding: 18px; }
            .topbar { padding: 0 16px; }
            .topbar-right .admin-badge span { display: none; }
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.5); z-index: 199;
        }
        .sidebar-overlay.active { display: block; }
    </style>
    <link rel="stylesheet" href="css/accessibility.css">
</head>
<body>

<!-- ============================================
     LOGIN PAGE
     ============================================ -->
<div class="login-container" id="loginContainer">
    <div class="login-box" id="loginBox">
        <div class="login-logo">
            <div class="icon" aria-hidden="true">üì±</div>
            <h1>LokAlert Admin</h1>
            <p>Sign in to your dashboard</p>
        </div>
        <div class="error-msg" id="loginError" role="alert" aria-live="assertive"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn btn-primary btn-lg">Sign In</button>
        </form>
        <a href="index.html" class="back-link">‚Üê Back to Website</a>
    </div>

    <!-- Invite Acceptance Box (hidden by default, shown when ?invite= param present) -->
    <div class="login-box invite-box" id="inviteBox" style="display:none;">
        <div class="login-logo">
            <div class="icon" aria-hidden="true">üéâ</div>
            <h1>Admin Invitation</h1>
            <p id="inviteSubtitle">You've been invited to join LokAlert Admin</p>
        </div>
        <div class="invite-badge" id="inviteBadge">‚úâÔ∏è Valid Invitation</div>
        <div class="error-msg" id="inviteError"></div>
        <div id="inviteDetails" style="margin-bottom: 20px; font-size: 14px;">
            <p>Name: <strong id="inviteName">-</strong></p>
            <p>Email: <strong id="inviteEmail">-</strong></p>
        </div>
        <form id="inviteForm">
            <div id="invitePasswordSection">
                <div class="form-group">
                    <label for="invitePassword">Set Your Password</label>
                    <input type="password" id="invitePassword" placeholder="Create a strong password" required minlength="8" oninput="checkPasswordStrength(this.value)">
                    <ul class="pw-requirements" id="pwRequirements">
                        <li id="pwLen">At least 8 characters</li>
                        <li id="pwUpper">An uppercase letter</li>
                        <li id="pwLower">A lowercase letter</li>
                        <li id="pwNum">A number</li>
                        <li id="pwSpecial">A special character (!@#$%^&*)</li>
                    </ul>
                </div>
            </div>
            <button type="submit" class="btn btn-success btn-lg">üöÄ Accept & Create Account</button>
        </form>
        <a href="admin.html" class="back-link">‚Üê Back to Login</a>
    </div>
</div>

<!-- ============================================
     DASHBOARD SHELL
     ============================================ -->
<div class="dashboard" id="dashboard">

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <span class="logo-icon" aria-hidden="true">üì±</span>
            <h2>LokAlert</h2>
        </div>
        <nav class="sidebar-nav" role="navigation" aria-label="Admin sidebar navigation">
            <div class="sidebar-nav-label">Main</div>
            <div class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')" role="button" tabindex="0" aria-current="page">
                <span class="nav-icon" aria-hidden="true">üìä</span> Dashboard
            </div>
            <div class="nav-item" data-page="releases" onclick="navigateTo('releases')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üì¶</span> Releases
            </div>

            <div class="sidebar-nav-label">Data</div>
            <div class="nav-item" data-page="database" onclick="navigateTo('database')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üóÑÔ∏è</span> Database
            </div>
            <div class="nav-item" data-page="users" onclick="navigateTo('users')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üë•</span> Users
            </div>
            <div class="nav-item" data-page="messages" onclick="navigateTo('messages')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üí¨</span> Messages <span class="nav-badge" id="msgBadge" style="display:none;">0</span>
            </div>

            <div class="sidebar-nav-label">System</div>
            <div class="nav-item" data-page="backups" onclick="navigateTo('backups')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üíæ</span> Backups
            </div>
            <div class="nav-item" data-page="admins" onclick="navigateTo('admins')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">üõ°Ô∏è</span> Admin Invites
            </div>
            <div class="nav-item" data-page="settings" onclick="navigateTo('settings')" role="button" tabindex="0">
                <span class="nav-icon" aria-hidden="true">‚öôÔ∏è</span> Settings
            </div>
        </nav>
        <div class="sidebar-footer">
            <a href="index.html" style="color: var(--text-muted); text-decoration: none; font-size: 12px;">üåê View Website</a>
            <span style="opacity:.45;">v4.0</span>
        </div>
    </aside>

    <!-- Main Area -->
    <div class="main-wrap">
        <!-- Maintenance Banner -->
        <div class="maintenance-banner" id="maintenanceBanner" role="alert"><span aria-hidden="true">üîß</span> Maintenance Mode is ACTIVE ‚Äî The public website is showing a maintenance page.</div>

        <!-- Top Bar -->
        <header class="topbar" role="banner">
            <div class="topbar-left">
                <button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()" aria-label="Toggle sidebar navigation">‚ò∞</button>
                <span class="page-title" id="pageTitle">Dashboard</span>
            </div>
            <div class="topbar-right">
                <div class="session-timer" id="sessionTimer" title="Session timeout" role="status" aria-live="polite">
                    <span aria-hidden="true">‚è±Ô∏è</span> <span id="sessionCountdown">--:--</span>
                </div>
                <div class="admin-badge">
                    <div class="avatar" id="adminAvatar">A</div>
                    <span id="adminName">Admin</span>
                </div>
                <button class="btn-logout-sm" onclick="logout()">Logout</button>
            </div>
        </header>

        <!-- Alert Container (toast notifications) -->
        <div id="alertContainer" role="alert" aria-live="assertive"></div>

        <!-- Main Content -->
        <main class="main-content" id="main-content" role="main">

            <!-- ========================================
                 PAGE: DASHBOARD
                 ======================================== -->
            <div class="page-section active" id="page-dashboard">

                <!-- Top Stats -->
                <div class="stats-row">
                    <div class="stat-card c1">
                        <div class="stat-icon" aria-hidden="true">üì¶</div>
                        <div class="stat-label">Total Releases</div>
                        <div class="stat-value" id="statReleases">0</div>
                    </div>
                    <div class="stat-card c2">
                        <div class="stat-icon" aria-hidden="true">üì•</div>
                        <div class="stat-label">Total Downloads</div>
                        <div class="stat-value" id="statDownloads">0</div>
                    </div>
                    <div class="stat-card c3">
                        <div class="stat-icon" aria-hidden="true">üöÄ</div>
                        <div class="stat-label">Latest Version</div>
                        <div class="stat-value" id="statLatest">-</div>
                    </div>
                    <div class="stat-card c4">
                        <div class="stat-icon" aria-hidden="true">üìä</div>
                        <div class="stat-label">Total Size</div>
                        <div class="stat-value" id="statSize">0 MB</div>
                    </div>
                    <div class="stat-card c5">
                        <div class="stat-icon" aria-hidden="true">üë•</div>
                        <div class="stat-label">Registered Users</div>
                        <div class="stat-value" id="statTotalUsers">0</div>
                    </div>
                </div>

                <!-- Two-column grid: DB overview + Recent activity -->
                <div class="dash-grid">
                    <div class="card">
                        <div class="card-header">
                            <h2>üóÑÔ∏è Database Overview</h2>
                            <button class="btn btn-sm btn-ghost" onclick="navigateTo('database')">View All ‚Üí</button>
                        </div>
                        <div class="mini-stat-grid">
                            <div class="mini-stat">
                                <div class="ms-val" style="color:var(--primary);" id="dbVersions">0</div>
                                <div class="ms-label">APK Versions</div>
                            </div>
                            <div class="mini-stat">
                                <div class="ms-val" style="color:var(--secondary);" id="dbUsers">0</div>
                                <div class="ms-label">Users</div>
                            </div>
                            <div class="mini-stat">
                                <div class="ms-val" style="color:var(--success);" id="dbLogs">0</div>
                                <div class="ms-label">Download Logs</div>
                            </div>
                            <div class="mini-stat">
                                <div class="ms-val" style="color:var(--warning);" id="dbMessages">0</div>
                                <div class="ms-label">Messages</div>
                            </div>
                        </div>
                        <!-- hidden span for JS compat -->
                        <span id="dbTotalDownloads" style="display:none;">0</span>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>üìú Recent Activity</h2>
                        </div>
                        <div style="max-height: 210px; overflow-y: auto; font-family: 'Inter', monospace; font-size: 12px;" id="activityLog">
                            <div id="activityEntries" style="color: var(--text-muted);">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card" style="margin-top: 0;">
                    <div class="card-header"><h2>‚ö° Quick Actions</h2></div>
                    <div class="quick-actions">
                        <button class="btn btn-sm btn-primary" onclick="navigateTo('releases')">‚ûï New Release</button>
                        <button class="btn btn-sm btn-success" onclick="exportDatabase()">üì§ Backup Database</button>
                        <button class="btn btn-sm btn-ghost" onclick="navigateTo('users')">üë• Manage Users</button>
                        <button class="btn btn-sm btn-ghost" onclick="navigateTo('admins')">üõ°Ô∏è Invite Admin</button>
                        <a href="index.html" class="btn btn-sm btn-ghost" target="_blank">üåê View Website</a>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: RELEASES
                 ======================================== -->
            <div class="page-section" id="page-releases">

                <!-- Add New Release -->
                <div class="card">
                    <div class="card-header">
                        <h2>‚ûï Add New APK Release</h2>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-sm" id="tabUpload" onclick="showReleaseTab('upload')" style="background: var(--primary); color: #fff;">üì§ Upload</button>
                            <button class="btn btn-sm btn-ghost" id="tabUrl" onclick="showReleaseTab('url')">üîó From URL</button>
                            <button class="btn btn-sm btn-ghost" id="tabDbUpload" onclick="showReleaseTab('dbupload')">üíæ Store in DB</button>
                        </div>
                    </div>

                    <!-- TAB 1: Direct Upload (GitHub) -->
                    <div id="uploadTab">
                        <div style="background: rgba(34,197,94,.06); border: 1px solid rgba(34,197,94,.2); border-radius: 10px; padding: 14px; margin-bottom: 18px;">
                            <p style="color: var(--success); margin: 0; font-size: 13px;">
                                <strong>üöÄ One-Click Publish:</strong> Upload your APK and it auto-publishes to GitHub Releases!
                            </p>
                            <div id="githubStatus" style="margin-top: 6px; font-size: 12px; color: var(--text-muted);">Checking GitHub connection...</div>
                        </div>
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>APK File *</label>
                                <div id="dropZone" style="border: 2px dashed var(--border); border-radius: 12px; padding: 36px 20px; text-align: center; cursor: pointer; transition: all .2s;">
                                    <div id="dropZoneContent">
                                        <div style="font-size: 40px; margin-bottom: 10px;">üì±</div>
                                        <p style="margin: 0; font-size: 14px; color: var(--text);">Drag & drop your APK here</p>
                                        <p style="color: var(--text-muted); margin: 6px 0; font-size: 13px;">or click to browse</p>
                                        <input type="file" id="apkFile" accept=".apk" style="display: none;">
                                    </div>
                                    <div id="filePreview" style="display: none;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
                                        <p style="color: var(--success); font-weight: 600;" id="selectedFileName">-</p>
                                        <p style="color: var(--text-muted);" id="selectedFileSize">-</p>
                                        <button type="button" class="btn btn-sm btn-ghost" onclick="clearFileSelection()" style="margin-top: 10px;">‚úï Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Version Number *</label>
                                    <input type="text" id="uploadVersion" placeholder="e.g., 1.0.0" required pattern="\d+\.\d+(\.\d+)?">
                                    <small style="color: var(--text-muted); font-size: 11px;">Format: X.Y or X.Y.Z</small>
                                </div>
                                <div class="form-group">
                                    <label>Release Name (Optional)</label>
                                    <input type="text" id="uploadReleaseName" placeholder="e.g., Bug fixes & improvements">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Release Notes / Changelog</label>
                                <textarea id="uploadReleaseNotes" placeholder="‚Ä¢ New feature 1&#10;‚Ä¢ Bug fix 2&#10;‚Ä¢ Improvement 3" rows="3"></textarea>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="uploadIsLatest" checked>
                                <label for="uploadIsLatest">Set as Latest Release</label>
                            </div>
                            <div id="uploadProgress" style="display: none; margin: 16px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                    <span id="uploadStatusText">Uploading...</span>
                                    <span id="uploadPercent">0%</span>
                                </div>
                                <div style="background: var(--bg-input); border-radius: 6px; height: 6px; overflow: hidden;">
                                    <div id="uploadProgressBar" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); height: 100%; width: 0%; transition: width .3s;"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="margin-top: 8px;" id="uploadBtn">üöÄ Upload & Publish</button>
                        </form>
                    </div>

                    <!-- TAB 2: From URL -->
                    <div id="urlTab" style="display: none;">
                        <div style="background: rgba(34,211,238,.06); border: 1px solid rgba(34,211,238,.2); border-radius: 10px; padding: 14px; margin-bottom: 18px;">
                            <p style="color: var(--secondary); margin: 0; font-size: 13px;">
                                <strong>üîó Link Mode:</strong> Already uploaded to GitHub? Just paste the URL!
                            </p>
                        </div>
                        <form id="releaseForm">
                            <div class="form-group">
                                <label>Download URL * <span style="color: var(--secondary);">(Paste GitHub Release URL)</span></label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="url" id="downloadUrl" placeholder="https://github.com/owner/repo/releases/download/v1.0.0/app.apk" required style="flex: 1;">
                                    <button type="button" class="btn btn-sm btn-ghost" onclick="fetchReleaseInfo()" id="fetchBtn">üîç Fetch</button>
                                </div>
                                <small style="color: var(--text-muted); font-size: 11px;">Supports: GitHub Releases, Google Drive, Dropbox</small>
                            </div>
                            <div id="autoFilledSection" style="background: rgba(99,102,241,.04); border-radius: 10px; padding: 16px; margin: 14px 0; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: var(--primary-light); font-weight: 600; font-size: 13px;">üìã Auto-detected Info</span>
                                    <span class="badge badge-success" id="fetchStatus">‚úì Fetched</span>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label>Version *</label><input type="text" id="versionNumber" placeholder="e.g., 1.0.0" required></div>
                                    <div class="form-group"><label>File Size</label><input type="text" id="fileSizeDisplay" readonly style="opacity:.6;"><input type="hidden" id="fileSize"></div>
                                </div>
                                <div class="form-group"><label>Release Notes</label><textarea id="releaseNotes" placeholder="What's new?" rows="3"></textarea></div>
                            </div>
                            <div id="manualSection">
                                <div class="form-row">
                                    <div class="form-group"><label>Version *</label><input type="text" id="versionNumberManual" placeholder="e.g., 1.0.0"></div>
                                    <div class="form-group"><label>File Size (bytes)</label><input type="number" id="fileSizeManual" placeholder="e.g., 17000000" min="0"></div>
                                </div>
                                <div class="form-group"><label>Release Notes</label><textarea id="releaseNotesManual" placeholder="What's new?"></textarea></div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="isLatest" checked>
                                <label for="isLatest">Set as Latest Release</label>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 8px;">üì§ Add Release</button>
                        </form>
                    </div>

                    <!-- TAB 3: Store in Database -->
                    <div id="dbUploadTab" style="display: none;">
                        <div style="background: rgba(167,139,250,.06); border: 1px solid rgba(167,139,250,.2); border-radius: 10px; padding: 14px; margin-bottom: 18px;">
                            <p style="color: #a78bfa; margin: 0; font-size: 13px;">
                                <strong>üíæ Database Storage:</strong> Store the APK directly in the database. This bypasses InfinityFree's .apk file deletion. Max ~50MB.
                            </p>
                        </div>
                        <div id="dbUploadStatus" style="margin-bottom: 14px; padding: 10px; background: rgba(245,158,11,.08); border-radius: 8px; border-left: 3px solid var(--warning); font-size: 13px; color: var(--warning);">
                            ‚ö†Ô∏è Check Settings to enable APK Database Storage first.
                        </div>
                        <form id="dbUploadForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>APK File * (max ~50MB)</label>
                                <input type="file" id="dbApkFile" accept=".apk" style="padding: 10px;">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Version Number *</label>
                                    <input type="text" id="dbUploadVersion" placeholder="e.g., 1.0.0" required pattern="\d+\.\d+(\.\d+)?">
                                </div>
                                <div class="form-group">
                                    <label>Release Notes</label>
                                    <input type="text" id="dbUploadNotes" placeholder="What's new?">
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="dbUploadIsLatest" checked>
                                <label for="dbUploadIsLatest">Set as Latest Release</label>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 8px;" id="dbUploadBtn">üíæ Upload to Database</button>
                        </form>
                    </div>
                </div>

                <!-- Releases List -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìã APK Releases</h2>
                        <button class="btn btn-sm btn-ghost" onclick="loadReleasesFromDB()">üîÑ Refresh</button>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr><th>Version</th><th>Download URL</th><th>Size</th><th>Downloads</th><th>Date</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="releasesTable"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="icon">üì¶</div>
                        <h3 style="color: var(--text-heading); margin-bottom: 6px;">No Releases Yet</h3>
                        <p>Add your first APK release using the form above.</p>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: DATABASE
                 ======================================== -->
            <div class="page-section" id="page-database">
                <div class="stats-row">
                    <div class="stat-card c1"><div class="stat-icon">üì¶</div><div class="stat-label">APK Versions</div><div class="stat-value" id="dbVersions2">0</div></div>
                    <div class="stat-card c2"><div class="stat-icon">üë•</div><div class="stat-label">Total Users</div><div class="stat-value" id="dbUsers2">0</div></div>
                    <div class="stat-card c3"><div class="stat-icon">üìä</div><div class="stat-label">Download Logs</div><div class="stat-value" id="dbLogs2">0</div></div>
                    <div class="stat-card c4"><div class="stat-icon">üí¨</div><div class="stat-label">Messages</div><div class="stat-value" id="dbMessages2">0</div></div>
                    <div class="stat-card c5"><div class="stat-icon">üì•</div><div class="stat-label">Total Downloads</div><div class="stat-value" id="dbTotalDownloads2">0</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üìã Database Tables</h2><button class="btn btn-sm btn-ghost" onclick="refreshDatabase()">üîÑ Refresh</button></div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 14px;">Click a table name to browse its records interactively.</p>
                    <div class="table-wrap">
                        <table class="table-clickable"><thead><tr><th>Table</th><th>Description</th><th>Records</th><th>Engine</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="dbTablesBody"><tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading tables...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üìú Audit Log</h2></div>
                    <div style="max-height: 300px; overflow-y: auto; font-size: 12px;" id="activityLogDB">
                        <div id="activityEntriesDB" style="color: var(--text-muted); font-family: 'Inter', monospace;">Loading audit log...</div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: USERS
                 ======================================== -->
            <div class="page-section" id="page-users">
                <div class="stats-row">
                    <div class="stat-card c2"><div class="stat-icon">üë§</div><div class="stat-label">Total Users</div><div class="stat-value" id="statTotalUsers2">0</div></div>
                    <div class="stat-card c3"><div class="stat-icon">‚úÖ</div><div class="stat-label">Verified</div><div class="stat-value" id="statVerifiedUsers">0</div></div>
                    <div class="stat-card c4"><div class="stat-icon">üìõ</div><div class="stat-label">With Names</div><div class="stat-value" id="statUsersWithNames">0</div></div>
                    <div class="stat-card c1"><div class="stat-icon">üì•</div><div class="stat-label">Downloaded</div><div class="stat-value" id="statUsersDownloaded">0</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üìã Registered Users</h2><button class="btn btn-sm btn-ghost" onclick="loadUsers()">üîÑ Refresh</button></div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Verified</th><th>Downloads</th><th>Joined</th><th>Actions</th></tr></thead>
                            <tbody id="usersTable"><tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading users...</td></tr></tbody>
                        </table>
                    </div>
                    <div class="info-box"><strong>Note:</strong> Passwords are never displayed. Use the üîê button to reset a user's password or send a self-service reset email.</div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: MESSAGES / INQUIRIES
                 ======================================== -->
            <div class="page-section" id="page-messages">
                <div class="stats-row">
                    <div class="stat-card c4"><div class="stat-icon">üí¨</div><div class="stat-label">Total Messages</div><div class="stat-value" id="statMsgTotal">0</div></div>
                    <div class="stat-card c3"><div class="stat-icon">üìñ</div><div class="stat-label">Read</div><div class="stat-value" id="statMsgRead">0</div></div>
                    <div class="stat-card c1"><div class="stat-icon">üîî</div><div class="stat-label">Unread</div><div class="stat-value" id="statMsgUnread">0</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2>üì® Contact Messages / Inquiries</h2>
                        <div style="display:flex;gap:6px;">
                            <button class="btn btn-sm btn-ghost" onclick="loadMessages()">üîÑ Refresh</button>
                            <button class="btn btn-sm btn-ghost" id="msgFilterBtn" onclick="toggleMsgFilter()">üìã All</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>#</th><th>Name</th><th>Email</th><th>Subject</th><th>Message</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                            <tbody id="messagesTable"><tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading messages...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: BACKUPS
                 ======================================== -->
            <div class="page-section" id="page-backups">
                <div class="card">
                    <div class="card-header"><h2>üíæ Backup & Recovery</h2><span class="badge badge-success">System Ready</span></div>
                    <div class="backup-grid">
                        <div class="backup-action" onclick="exportDatabase()"><div class="ba-icon">üì§</div><div class="ba-title">Create Backup</div><div class="ba-desc">Export full SQL dump of all tables and data</div></div>
                        <div class="backup-action" onclick="exportDatabase('preview')"><div class="ba-icon">üëÅÔ∏è</div><div class="ba-title">Preview SQL</div><div class="ba-desc">View the backup SQL in browser before downloading</div></div>
                        <div class="backup-action" onclick="showBackupInstructions('import')"><div class="ba-icon">üì•</div><div class="ba-title">Restore / Import</div><div class="ba-desc">Import a previously exported SQL backup file</div></div>
                        <div class="backup-action" onclick="showBackupInstructions('rollback')"><div class="ba-icon">‚è™</div><div class="ba-title">Rollback</div><div class="ba-desc">Revert to a previous backup state</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üìÖ Backup History</h2></div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>#</th><th>Created By</th><th>Date & Time</th><th>IP Address</th></tr></thead>
                            <tbody id="backupHistoryBody"><tr><td colspan="4" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading backup history...</td></tr></tbody>
                        </table>
                    </div>
                    <div class="info-box"><strong>üí° Tip:</strong> Backups are full SQL dumps importable into any MySQL/MariaDB instance. For InfinityFree, use phpMyAdmin ‚Üí SQL tab.</div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: ADMIN INVITES
                 ======================================== -->
            <div class="page-section" id="page-admins">
                <div class="card">
                    <div class="card-header"><h2>üëë Current Admins</h2><button class="btn btn-sm btn-ghost" onclick="loadAdminUsers()">üîÑ Refresh</button></div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Joined</th><th>Actions</th></tr></thead>
                            <tbody id="adminUsersTable"><tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading admins...</td></tr></tbody>
                        </table>
                    </div>
                    <div class="info-box">üõ°Ô∏è <strong>Promote users</strong> from the Users page using the shield button, or <strong>invite new admins</strong> below.</div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üõ°Ô∏è Invite New Admin</h2></div>
                    <form id="inviteAdminForm" onsubmit="submitAdminInvite(event)">
                        <div class="form-row">
                            <div class="form-group"><label>Name</label><input type="text" id="inviteAdminName" placeholder="New admin's name"></div>
                            <div class="form-group"><label>Email *</label><input type="email" id="inviteAdminEmail" placeholder="admin@example.com" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pre-set Password (optional)</label>
                                <input type="text" id="inviteAdminPassword" placeholder="Leave empty for them to set">
                                <small style="color: var(--text-muted); font-size: 11px;">If set, they won't need to create a password</small>
                            </div>
                            <div class="form-group">
                                <label>Link Expires In (hours)</label>
                                <input type="number" id="inviteAdminExpiry" value="48" min="1" max="720">
                                <small style="color: var(--text-muted); font-size: 11px;">1-720 hours (default 48h)</small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚úâÔ∏è Send Invitation</button>
                    </form>
                    <div id="inviteResult" style="margin-top: 16px;"></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>üìã Invitation History</h2><button class="btn btn-sm btn-ghost" onclick="loadInvites()">üîÑ Refresh</button></div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Created</th><th>Expires</th><th>Actions</th></tr></thead>
                            <tbody id="invitesTable"><tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding: 20px;">Loading invites...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 PAGE: SETTINGS
                 ======================================== -->
            <div class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è Admin Settings</h2>
                        <button class="btn btn-sm btn-primary" onclick="saveSettings()" id="saveSettingsBtn">üíæ Save All</button>
                    </div>
                    <div class="settings-grid" id="settingsGrid">
                        <div style="text-align:center; color:var(--text-muted); grid-column: 1 / -1; padding: 30px;">Loading settings...</div>
                    </div>
                    <div class="info-box">
                        <strong>‚ö†Ô∏è Note:</strong> Session timeout changes take effect on the next page load.
                        Login lockout and cooldown settings are applied immediately for new requests.
                        Maintenance mode immediately affects the public website.
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<!-- ============================================
     MODALS
     ============================================ -->

<!-- Edit Release Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit Release</h3>
        <form id="editForm">
            <input type="hidden" id="editId">
            <div class="form-group"><label>Version Number</label><input type="text" id="editVersion" required></div>
            <div class="form-group"><label>Download URL</label><input type="text" id="editUrl" required></div>
            <div class="form-group"><label>Release Notes</label><textarea id="editNotes"></textarea></div>
            <div class="checkbox-group">
                <input type="checkbox" id="editIsLatest"><label for="editIsLatest">Set as Latest Release</label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- User Edit Modal -->
<div class="modal-overlay" id="userEditModal" role="dialog" aria-modal="true" aria-label="Edit User">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit User</h3>
        <form id="userEditForm" onsubmit="saveUserEdit(event)">
            <input type="hidden" id="userEditId">
            <div class="form-group"><label for="userEditName">Name</label><input type="text" id="userEditName" placeholder="User's name"></div>
            <div class="form-group"><label for="userEditEmail">Email</label><input type="email" id="userEditEmail" required></div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeUserEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Password Reset Modal -->
<div class="modal-overlay" id="passwordResetModal" role="dialog" aria-modal="true" aria-label="Reset User Password">
    <div class="modal-content">
        <h3>üîê Reset User Password</h3>
        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">User: <strong id="resetUserEmail" style="color:var(--text);"></strong></p>
        <input type="hidden" id="resetUserId">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-primary btn-sm" onclick="sendResetEmail()">üìß Send Reset Email</button>
            <div style="text-align: center; color: var(--text-muted); font-size: 12px;">‚Äî or ‚Äî</div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="tempPassword">Set Temporary Password</label>
                <input type="text" id="tempPassword" placeholder="Min 6 characters">
            </div>
            <button class="btn btn-sm btn-warning" onclick="setTempPassword()">üîë Set Password</button>
        </div>
        <div id="resetResult" style="margin-top: 12px;"></div>
        <button type="button" class="btn btn-sm btn-ghost" onclick="closePasswordResetModal()" style="margin-top: 16px; width: 100%;">Close</button>
    </div>
</div>

<!-- Table Browser Modal -->
<div class="modal-overlay" id="tableBrowserModal" style="display:none;" role="dialog" aria-modal="true" aria-label="Table Browser">
    <div class="modal-content modal-large">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
            <h3 id="browserTableTitle" style="margin: 0;">üìã Table: <span id="browserTableName">‚Äî</span></h3>
            <div style="display: flex; gap: 6px;">
                <button class="btn btn-sm btn-primary" onclick="refreshBrowserTable()">üîÑ Refresh</button>
                <button class="btn btn-sm btn-ghost" onclick="closeBrowserModal()">‚úï Close</button>
            </div>
        </div>
        <div class="browser-toolbar" id="browserToolbar">
            <span style="color: var(--text-muted); font-size: 12px;" id="browserStats">Showing 0 records</span>
            <div class="browser-pagination" id="browserPagination"></div>
        </div>
        <div style="overflow-x: auto; max-height: 55vh; overflow-y: auto;">
            <table class="data-table" id="browserDataTable">
                <thead id="browserTableHead"><tr><th>Loading...</th></tr></thead>
                <tbody id="browserTableBody"><tr><td>Loading data...</td></tr></tbody>
            </table>
        </div>
        <div class="browser-toolbar" style="margin-top: 10px;" id="browserBottomToolbar">
            <span></span>
            <div class="browser-pagination" id="browserPaginationBottom"></div>
        </div>
    </div>
</div>

<!-- Edit Record Modal -->
<div class="modal-overlay" id="editRecordModal" style="display:none;" role="dialog" aria-modal="true" aria-label="Edit Record">
    <div class="modal-content" style="max-width: 600px;">
        <h3>‚úèÔ∏è Edit Record</h3>
        <p style="color: var(--text-muted); margin-bottom: 14px; font-size: 13px;">Table: <strong id="editRecordTable" style="color:var(--text);">‚Äî</strong> | ID: <strong id="editRecordId" style="color:var(--text);">‚Äî</strong></p>
        <form id="editRecordForm" onsubmit="saveRecordEdit(event)">
            <div id="editRecordFields"></div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Save Changes</button>
                <button type="button" class="btn btn-ghost" onclick="closeEditRecordModal()" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Backup Instructions Modal -->
<div class="modal-overlay" id="backupInstructionsModal" style="display:none;" role="dialog" aria-modal="true" aria-label="Instructions">
    <div class="modal-content" style="max-width: 620px;">
        <h3 id="backupInstructionsTitle">üìñ Instructions</h3>
        <div id="backupInstructionsBody" style="color: var(--text-muted); line-height: 1.8; font-size: 14px;"></div>
        <button type="button" class="btn btn-sm btn-ghost" onclick="document.getElementById('backupInstructionsModal').style.display='none'" style="margin-top: 16px; width: 100%;">Close</button>
    </div>
</div>


<!-- ============================================
     JAVASCRIPT
     ============================================ -->
<script src="js/accessibility.js"></script>
<script>
    // ============================================
    // Password Strength Helpers
    // ============================================
    function checkPasswordStrength(pw) {
        const rules = [
            { id: 'pwLen',     test: pw.length >= 8 },
            { id: 'pwUpper',   test: /[A-Z]/.test(pw) },
            { id: 'pwLower',   test: /[a-z]/.test(pw) },
            { id: 'pwNum',     test: /[0-9]/.test(pw) },
            { id: 'pwSpecial', test: /[^A-Za-z0-9]/.test(pw) }
        ];
        rules.forEach(r => {
            const el = document.getElementById(r.id);
            if (!el) return;
            el.classList.toggle('met', r.test);
            el.classList.toggle('unmet', !r.test && pw.length > 0);
        });
    }

    function isPasswordValid(pw) {
        return pw.length >= 8
            && /[A-Z]/.test(pw)
            && /[a-z]/.test(pw)
            && /[0-9]/.test(pw)
            && /[^A-Za-z0-9]/.test(pw);
    }

    // ============================================
    // State Management
    // ============================================
    let isLoggedIn = false;
    let releases = [];
    let currentUser = null;
    let sessionTimeoutMinutes = 5;
    let sessionTimerInterval = null;
    let sessionSecondsLeft = 0;
    let browserCurrentTable = '';
    let browserCurrentPage = 1;
    let currentPage = 'dashboard';
    
    const API_BASE = 'api';
    const _isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const _creds = _isLocal ? {} : { credentials: 'include' };

    /** Helper: fetch with auto credentials for production */
    function apiFetch(url, opts) {
        opts = opts || {};
        return fetch(url, Object.assign({}, _creds, opts));
    }

    // ============================================
    // Invite Token Check (runs before anything else)
    // ============================================
    (function checkInviteToken() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('invite');
        if (!token) return;

        // Show invite box, hide login box
        document.getElementById('loginBox').style.display = 'none';
        const inviteBox = document.getElementById('inviteBox');
        inviteBox.style.display = 'block';
        const inviteError = document.getElementById('inviteError');
        const inviteBadge = document.getElementById('inviteBadge');

        // Validate token
        apiFetch(`${API_BASE}/auth.php?action=validate-invite&token=${encodeURIComponent(token)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.valid) {
                    inviteBadge.textContent = '‚ùå Invalid';
                    inviteBadge.style.background = 'rgba(239,68,68,.1)';
                    inviteBadge.style.color = 'var(--danger)';
                    inviteError.textContent = data.error || 'This invitation is not valid.';
                    inviteError.style.display = 'block';
                    document.getElementById('inviteForm').style.display = 'none';
                    return;
                }
                document.getElementById('inviteName').textContent = data.name || '(not set)';
                document.getElementById('inviteEmail').textContent = data.email;
                if (data.has_password) {
                    document.getElementById('invitePasswordSection').innerHTML = '<p style="color:var(--success);font-size:14px;">‚úÖ A password has been pre-set for you. Just click the button below!</p>';
                }
            })
            .catch(() => {
                inviteError.textContent = 'Could not validate invitation. Server may be unavailable.';
                inviteError.style.display = 'block';
            });

        // Handle form submit
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('invitePassword')?.value || '';
            const btn = e.target.querySelector('button[type="submit"]');

            // Validate password strength (only if password field is visible)
            if (document.getElementById('invitePassword') && password && !isPasswordValid(password)) {
                inviteError.textContent = 'Password does not meet all requirements';
                inviteError.style.display = 'block';
                checkPasswordStrength(password);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating account...';
            
            try {
                const resp = await apiFetch(`${API_BASE}/auth.php?action=accept-invite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password })
                });
                const data = await resp.json();
                if (data.success) {
                    inviteBox.innerHTML = `<div class="login-logo"><div class="icon">üéâ</div><h1>Welcome!</h1></div>
                        <p style="text-align:center;color:var(--success);margin-bottom:20px;">${data.message}</p>
                        <a href="admin.html" class="btn btn-primary btn-lg">üîê Go to Login</a>`;
                } else {
                    inviteError.textContent = data.error || 'Failed to create account';
                    inviteError.style.display = 'block';
                }
            } catch(err) {
                inviteError.textContent = 'Network error';
                inviteError.style.display = 'block';
            }
            btn.disabled = false;
            btn.textContent = 'üöÄ Accept & Create Account';
        });
    })();

    // ============================================
    // Navigation
    // ============================================
    function navigateTo(page) {
        currentPage = page;
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        const target = document.getElementById('page-' + page);
        if (target) target.classList.add('active');

        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.remove('active');
            n.removeAttribute('aria-current');
        });
        const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
        if (navItem) {
            navItem.classList.add('active');
            navItem.setAttribute('aria-current', 'page');
        }
        
        const titles = {
            dashboard: 'Dashboard',
            releases: 'Release Management',
            database: 'Database Management',
            users: 'User Management',
            backups: 'Backup & Recovery',
            admins: 'Admin Management',
            settings: 'Settings'
        };
        document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
        closeSidebar();
        window.scrollTo(0, 0);

        // Load page-specific data
        if (page === 'admins') { loadAdminUsers(); loadInvites(); }
        if (page === 'users') { loadUsers(); }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    }

    // ============================================
    // Initialization
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            try {
                const resp = await apiFetch(`${API_BASE}/auth.php?action=check`);
                const data = await resp.json();
                if (data.authenticated && data.user && data.user.is_admin) {
                    isLoggedIn = true;
                    currentUser = data.user;
                    if (data.session_timeout_minutes) {
                        sessionTimeoutMinutes = parseInt(data.session_timeout_minutes);
                    }
                    const name = data.user.username || 'Admin';
                    document.getElementById('adminName').textContent = name;
                    document.getElementById('adminAvatar').textContent = name.charAt(0).toUpperCase();
                    showDashboard();
                } else if (data.reason === 'session_timeout') {
                    showAlert('Session expired due to inactivity. Please log in again.', 'error');
                }
            } catch (e) {
                console.log('Session check failed, showing login');
            }
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            
            const releaseForm = document.getElementById('releaseForm');
            if (releaseForm) releaseForm.addEventListener('submit', handleAddRelease);
            
            const editForm = document.getElementById('editForm');
            if (editForm) editForm.addEventListener('submit', handleEditRelease);
            
            // DB Upload form
            const dbUploadForm = document.getElementById('dbUploadForm');
            if (dbUploadForm) dbUploadForm.addEventListener('submit', handleDbUpload);
            
            console.log('Admin panel v4.0 initialized');
        } catch (e) {
            console.error('Init error:', e);
        }
    });

    // ============================================
    // Authentication
    // ============================================
    async function handleLogin(e) {
        e.preventDefault();
        const btn = document.querySelector('#loginForm button[type="submit"]');
        const errorEl = document.getElementById('loginError');
        
        try {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (errorEl) errorEl.style.display = 'none';
            if (btn) { btn.disabled = true; btn.textContent = 'Signing in...'; }
            
            if (!username || !password) {
                if (errorEl) { errorEl.textContent = 'Please enter username and password'; errorEl.style.display = 'block'; }
                if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
                return;
            }
            
            const response = await apiFetch(`${API_BASE}/auth.php?action=login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: username, password: password })
            });
            const data = await response.json();
            
            if (data.success && data.user && data.user.is_admin) {
                isLoggedIn = true;
                currentUser = data.user;
                const name = data.user.username || 'Admin';
                document.getElementById('adminName').textContent = name;
                document.getElementById('adminAvatar').textContent = name.charAt(0).toUpperCase();
                showDashboard();
            } else if (data.success) {
                if (errorEl) { errorEl.textContent = 'Account does not have admin privileges'; errorEl.style.display = 'block'; }
            } else {
                if (errorEl) { errorEl.textContent = data.error || 'Login failed. Check database connection.'; errorEl.style.display = 'block'; }
            }
        } catch (err) {
            console.error('Login error:', err);
            if (errorEl) { errorEl.textContent = 'Connection error. Server may be unavailable.'; errorEl.style.display = 'block'; }
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
        }
    }

    async function logout() {
        isLoggedIn = false;
        if (sessionTimerInterval) clearInterval(sessionTimerInterval);
        try {
            await apiFetch(`${API_BASE}/auth.php?action=logout`, { method: 'POST' });
        } catch(e) {}
        location.reload();
    }

    function showDashboard() {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('dashboard').classList.add('active');
        
        loadReleasesFromDB().catch(e => console.log('Error loading releases:', e));
        loadDatabaseStats();
        loadTableStats();
        loadUsers();
        loadMessages();
        loadAuditLog();
        loadSettings();
        loadBackupHistory();
        loadInvites();
        checkGitHubConfig();
        setupUploadHandlers();
        startSessionTimer();
        checkMaintenanceStatus();
    }

    // ============================================
    // Maintenance Status Check
    // ============================================
    async function checkMaintenanceStatus() {
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=maintenance-check`);
            const data = await resp.json();
            const banner = document.getElementById('maintenanceBanner');
            if (data.maintenance) {
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
        } catch(e) {}
    }

    // ============================================
    // Tab Switching (Upload vs URL vs DB)
    // ============================================
    function showReleaseTab(tab) {
        const uploadTab = document.getElementById('uploadTab');
        const urlTab = document.getElementById('urlTab');
        const dbUploadTab = document.getElementById('dbUploadTab');
        const tabUpload = document.getElementById('tabUpload');
        const tabUrl = document.getElementById('tabUrl');
        const tabDbUpload = document.getElementById('tabDbUpload');
        
        [uploadTab, urlTab, dbUploadTab].forEach(t => t.style.display = 'none');
        [tabUpload, tabUrl, tabDbUpload].forEach(t => { t.style.background = ''; t.style.color = ''; t.classList.add('btn-ghost'); });
        
        const activeTab = tab === 'upload' ? uploadTab : tab === 'url' ? urlTab : dbUploadTab;
        const activeBtn = tab === 'upload' ? tabUpload : tab === 'url' ? tabUrl : tabDbUpload;
        activeTab.style.display = 'block';
        activeBtn.style.background = 'var(--primary)';
        activeBtn.style.color = '#fff';
        activeBtn.classList.remove('btn-ghost');
    }

    // ============================================
    // GitHub Upload
    // ============================================
    let selectedFile = null;

    async function checkGitHubConfig() {
        const statusEl = document.getElementById('githubStatus');
        if (!statusEl) return;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        try {
            const response = await apiFetch(`${API_BASE}/github.php?action=check-token`, {
                                signal: controller.signal
            });
            clearTimeout(timeoutId);
            const data = await response.json();
            if (data.configured) {
                statusEl.innerHTML = `<span style="color: var(--success);">‚úÖ Connected: ${data.owner}/${data.repo}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color: var(--warning);">‚ö†Ô∏è GitHub not fully configured</span>`;
            }
        } catch (error) {
            clearTimeout(timeoutId);
            statusEl.innerHTML = `<span style="color: var(--text-muted);">GitHub check skipped</span>`;
        }
    }
    
    function setupUploadHandlers() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('apkFile');
        const uploadForm = document.getElementById('uploadForm');
        if (!dropZone || !fileInput || !uploadForm) return;
        
        dropZone.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });
        
        ['dragenter','dragover','dragleave','drop'].forEach(ev => {
            dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter','dragover'].forEach(ev => {
            dropZone.addEventListener(ev, () => {
                dropZone.style.borderColor = 'var(--primary)';
                dropZone.style.background = 'rgba(99,102,241,.06)';
            });
        });
        ['dragleave','drop'].forEach(ev => {
            dropZone.addEventListener(ev, () => {
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.background = '';
            });
        });
        dropZone.addEventListener('drop', (e) => {
            if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
        });
        uploadForm.addEventListener('submit', handleUploadSubmit);
    }

    function handleFileSelect(file) {
        if (!file.name.toLowerCase().endsWith('.apk')) {
            showAlert('Please select an APK file', 'error');
            return;
        }
        selectedFile = file;
        document.getElementById('dropZoneContent').style.display = 'none';
        document.getElementById('filePreview').style.display = 'block';
        document.getElementById('selectedFileName').textContent = file.name;
        document.getElementById('selectedFileSize').textContent = formatBytesAdmin(file.size);
        const v = file.name.match(/[vV]?(\d+\.\d+\.?\d*)/);
        if (v && !document.getElementById('uploadVersion').value) {
            document.getElementById('uploadVersion').value = v[1];
        }
    }

    function clearFileSelection() {
        selectedFile = null;
        document.getElementById('apkFile').value = '';
        document.getElementById('dropZoneContent').style.display = 'block';
        document.getElementById('filePreview').style.display = 'none';
    }

    async function handleUploadSubmit(e) {
        e.preventDefault();
        if (!selectedFile) { showAlert('Please select an APK file', 'error'); return; }
        
        const version = document.getElementById('uploadVersion').value.trim();
        const releaseNotes = document.getElementById('uploadReleaseNotes').value.trim();
        const isLatest = document.getElementById('uploadIsLatest').checked;
        
        if (!version) { showAlert('Please enter a version number', 'error'); return; }
        if (!/^\d+\.\d+(\.\d+)?$/.test(version)) { showAlert('Invalid version format. Use X.Y or X.Y.Z', 'error'); return; }
        
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚è≥ Uploading...';
        uploadProgress.style.display = 'block';
        
        try {
            const formData = new FormData();
            formData.append('apk', selectedFile);
            formData.append('version', version);
            formData.append('release_notes', releaseNotes);
            formData.append('is_latest', isLatest ? '1' : '0');
            
            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('uploadProgressBar').style.width = pct + '%';
                    document.getElementById('uploadPercent').textContent = pct + '%';
                    document.getElementById('uploadStatusText').textContent = pct < 100 ? 'Uploading to server...' : 'Publishing to GitHub...';
                }
            });
            xhr.addEventListener('load', () => {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        showAlert(`‚úÖ ${response.message}`, 'success');
                        clearFileSelection();
                        document.getElementById('uploadForm').reset();
                        document.getElementById('uploadIsLatest').checked = true;
                        loadReleasesFromDB();
                        updateStats();
                    } else {
                        showAlert('‚ùå ' + (response.error || 'Upload failed'), 'error');
                    }
                } catch(err) {
                    showAlert('‚ùå Invalid server response', 'error');
                }
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Upload & Publish';
                uploadProgress.style.display = 'none';
                document.getElementById('uploadProgressBar').style.width = '0%';
            });
            xhr.addEventListener('error', () => {
                showAlert('‚ùå Network error', 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Upload & Publish';
                uploadProgress.style.display = 'none';
            });
            xhr.open('POST', `${API_BASE}/github.php?action=upload`);
            xhr.withCredentials = true;
            xhr.send(formData);
        } catch (error) {
            showAlert('‚ùå ' + error.message, 'error');
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üöÄ Upload & Publish';
            uploadProgress.style.display = 'none';
        }
    }

    // ============================================
    // DB Upload Handler
    // ============================================
    async function handleDbUpload(e) {
        e.preventDefault();
        const fileInput = document.getElementById('dbApkFile');
        const version = document.getElementById('dbUploadVersion').value.trim();
        const notes = document.getElementById('dbUploadNotes').value.trim();
        const isLatest = document.getElementById('dbUploadIsLatest').checked;
        const btn = document.getElementById('dbUploadBtn');
        
        if (!fileInput.files.length) { showAlert('Please select an APK file', 'error'); return; }
        if (!version) { showAlert('Please enter a version number', 'error'); return; }
        
        const file = fileInput.files[0];
        if (file.size > 50 * 1024 * 1024) {
            showAlert('File too large! Max 50MB for database storage.', 'error');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Uploading to DB...';
        
        try {
            const formData = new FormData();
            formData.append('apk', file);
            formData.append('version', version);
            formData.append('release_notes', notes);
            formData.append('is_latest', isLatest ? '1' : '0');
            
            const resp = await apiFetch(`${API_BASE}/versions.php?action=upload-to-db`, {
                method: 'POST',
                                body: formData
            });
            const data = await resp.json();
            if (data.success) {
                showAlert('‚úÖ ' + data.message, 'success');
                document.getElementById('dbUploadForm').reset();
                document.getElementById('dbUploadIsLatest').checked = true;
                loadReleasesFromDB();
                updateStats();
            } else {
                showAlert('‚ùå ' + (data.error || 'Upload failed'), 'error');
            }
        } catch(err) {
            showAlert('‚ùå Network error: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.textContent = 'üíæ Upload to Database';
    }

    // ============================================
    // GitHub Release Auto-Fetch
    // ============================================
    let autoFetchedData = null;

    function parseGitHubUrl(url) {
        try {
            const u = new URL(url);
            if (!u.hostname.includes('github.com')) return null;
            const p = u.pathname.split('/').filter(x => x);
            if (p.length < 2) return null;
            const [owner, repo] = p;
            if (p[2] === 'releases' && p[3] === 'download') return { owner, repo, tag: p[4], filename: p[5] || null, type: 'download' };
            if (p[2] === 'releases' && p[3] === 'tag') return { owner, repo, tag: p[4], type: 'tag' };
            if (p[2] === 'releases' && (p[3] === 'latest' || !p[3])) return { owner, repo, tag: 'latest', type: 'latest' };
            return null;
        } catch(e) { return null; }
    }

    async function fetchReleaseInfo() {
        const urlInput = document.getElementById('downloadUrl');
        const fetchBtn = document.getElementById('fetchBtn');
        const url = urlInput.value.trim();
        
        if (!url) { showAlert('Please enter a URL first', 'error'); return; }
        
        const parsed = parseGitHubUrl(url);
        if (!parsed) {
            document.getElementById('autoFilledSection').style.display = 'none';
            document.getElementById('manualSection').style.display = 'block';
            showAlert('Not a GitHub URL. Fill in details manually.', 'error');
            return;
        }
        
        fetchBtn.disabled = true;
        fetchBtn.innerHTML = '‚è≥ Fetching...';
        
        try {
            const apiUrl = parsed.tag === 'latest'
                ? `https://api.github.com/repos/${parsed.owner}/${parsed.repo}/releases/latest`
                : `https://api.github.com/repos/${parsed.owner}/${parsed.repo}/releases/tags/${parsed.tag}`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Release not found');
            const release = await response.json();
            
            const version = release.tag_name.replace(/^v/i, '');
            const apkAsset = release.assets.find(a => a.name.toLowerCase().endsWith('.apk'));
            
            let downloadUrl = url, fileSize = 0, filename = '';
            if (apkAsset) {
                downloadUrl = apkAsset.browser_download_url;
                fileSize = apkAsset.size;
                filename = apkAsset.name;
            } else if (parsed.filename) {
                const m = release.assets.find(a => a.name === parsed.filename);
                if (m) { downloadUrl = m.browser_download_url; fileSize = m.size; filename = m.name; }
            }
            
            autoFetchedData = { version, fileSize, downloadUrl, filename, releaseNotes: release.body || '', releaseName: release.name || release.tag_name };
            
            document.getElementById('downloadUrl').value = downloadUrl;
            document.getElementById('versionNumber').value = version;
            document.getElementById('fileSize').value = fileSize;
            document.getElementById('fileSizeDisplay').value = formatBytesAdmin(fileSize);
            document.getElementById('releaseNotes').value = release.body || '';
            document.getElementById('autoFilledSection').style.display = 'block';
            document.getElementById('manualSection').style.display = 'none';
            document.getElementById('fetchStatus').innerHTML = `‚úì ${release.name || release.tag_name}`;
            
            showAlert(`Found: ${release.name || release.tag_name} (${formatBytesAdmin(fileSize)})`, 'success');
        } catch (error) {
            showAlert('Could not fetch: ' + error.message, 'error');
            document.getElementById('autoFilledSection').style.display = 'none';
            document.getElementById('manualSection').style.display = 'block';
            const v = url.match(/[vV]?(\d+\.\d+\.?\d*)/);
            if (v) document.getElementById('versionNumberManual').value = v[1];
        } finally {
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = 'üîç Fetch';
        }
    }

    function formatBytesAdmin(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ============================================
    // Release Management (DB-backed)
    // ============================================
    async function handleAddRelease(e) {
        e.preventDefault();
        const autoVisible = document.getElementById('autoFilledSection').style.display !== 'none';
        let version, fileSize, releaseNotes;
        
        if (autoVisible) {
            version = document.getElementById('versionNumber').value.trim();
            fileSize = parseInt(document.getElementById('fileSize').value) || 0;
            releaseNotes = document.getElementById('releaseNotes').value.trim();
        } else {
            version = document.getElementById('versionNumberManual').value.trim();
            fileSize = parseInt(document.getElementById('fileSizeManual').value) || 0;
            releaseNotes = document.getElementById('releaseNotesManual').value.trim();
        }
        
        const downloadUrl = document.getElementById('downloadUrl').value.trim();
        const isLatest = document.getElementById('isLatest').checked;
        
        if (!version) { showAlert('Please enter a version number', 'error'); return; }
        if (!downloadUrl.startsWith('http')) { showAlert('Please enter a valid URL', 'error'); return; }
        
        try {
            const response = await apiFetch(`${API_BASE}/versions.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ version, file_size: fileSize, download_url: downloadUrl, release_notes: releaseNotes, is_latest: isLatest ? 1 : 0 })
            });
            const data = await response.json();
            if (data.success) {
                showAlert('Release added successfully!', 'success');
                document.getElementById('releaseForm').reset();
                document.getElementById('isLatest').checked = true;
                document.getElementById('autoFilledSection').style.display = 'none';
                document.getElementById('manualSection').style.display = 'block';
                autoFetchedData = null;
                await loadReleasesFromDB();
                updateStats();
            } else {
                showAlert(data.error || 'Failed to add release', 'error');
            }
        } catch(error) {
            showAlert('Network error', 'error');
        }
    }

    async function loadReleasesFromDB() {
        try {
            const response = await apiFetch(`${API_BASE}/versions.php`);
            const data = await response.json();
            if (Array.isArray(data)) {
                releases = data.map(r => ({
                    id: r.id, version: r.version, fileSize: r.file_size,
                    downloadUrl: r.download_url || r.filename, download_url: r.download_url,
                    releaseNotes: r.release_notes, downloads: r.download_count || 0,
                    isLatest: r.is_latest == 1, createdAt: r.upload_date,
                    storedInDb: r.stored_in_db == 1
                }));
                loadReleases();
                updateStats();
            }
        } catch(error) {
            showAlert('Could not connect to database', 'error');
        }
    }

    async function deleteRelease(id) {
        if (!confirm('Delete this release permanently?')) return;
        try {
            const r = await apiFetch(`${API_BASE}/versions.php?id=${id}`, { method: 'DELETE' });
            const d = await r.json();
            if (d.success) { showAlert('Release deleted!', 'success'); await loadReleasesFromDB(); }
            else { showAlert(d.error || 'Failed to delete', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
        updateStats();
    }

    async function setAsLatest(id) {
        try {
            const r = await apiFetch(`${API_BASE}/versions.php?id=${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ is_latest: 1 })
            });
            const d = await r.json();
            if (d.success) { showAlert('Set as latest!', 'success'); await loadReleasesFromDB(); }
            else { showAlert(d.error || 'Failed', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
        updateStats();
    }

    async function handleEditRelease(e) {
        e.preventDefault();
        const id = parseInt(document.getElementById('editId').value);
        const version = document.getElementById('editVersion').value.trim();
        const downloadUrl = document.getElementById('editUrl').value.trim();
        const releaseNotes = document.getElementById('editNotes').value.trim();
        const isLatest = document.getElementById('editIsLatest').checked;
        
        try {
            const r = await apiFetch(`${API_BASE}/versions.php?id=${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ version, download_url: downloadUrl, release_notes: releaseNotes, is_latest: isLatest ? 1 : 0 })
            });
            const d = await r.json();
            if (d.success) { closeEditModal(); await loadReleasesFromDB(); updateStats(); showAlert('Release updated!', 'success'); }
            else { showAlert(d.error || 'Failed to update', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    function openEditModal(id) {
        const r = releases.find(x => x.id === id);
        if (r) {
            document.getElementById('editId').value = r.id;
            document.getElementById('editVersion').value = r.version;
            document.getElementById('editUrl').value = r.downloadUrl || r.download_url || '';
            document.getElementById('editNotes').value = r.releaseNotes || '';
            document.getElementById('editIsLatest').checked = r.isLatest;
            document.getElementById('editModal').classList.add('active');
        }
    }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

    // ============================================
    // Data Display
    // ============================================
    function loadReleases() {
        const tbody = document.getElementById('releasesTable');
        const emptyState = document.getElementById('emptyState');
        
        if (releases.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; }
        emptyState.style.display = 'none';
        
        tbody.innerHTML = releases.map(r => {
            const url = r.download_url || r.downloadUrl || '#';
            const displayUrl = url.length > 40 ? url.substring(0, 40) + '...' : url;
            const fs = r.fileSize || r.file_size || 0;
            const fsD = fs > 1000000 ? (fs / 1048576).toFixed(1) + ' MB' : (fs > 0 ? fs + ' B' : '-');
            const dl = r.downloads || r.download_count || 0;
            const dbBadge = r.storedInDb ? ' <span class="badge badge-primary" title="Stored in Database">üíæ DB</span>' : '';
            return `<tr>
                <td><strong>v${r.version}</strong>${dbBadge}</td>
                <td><a href="${url}" target="_blank" style="color:var(--primary-light);word-break:break-all;" title="${url}">${displayUrl}</a></td>
                <td>${fsD}</td><td>${dl}</td>
                <td>${formatDate(r.createdAt || r.upload_date)}</td>
                <td>${(r.isLatest || r.is_latest == 1) ? '<span class="badge badge-success">‚úì Latest</span>' : '<span class="badge badge-primary">Archive</span>'}</td>
                <td class="actions">
                    <a href="${url}" target="_blank" class="btn btn-sm btn-success" title="Download">üì•</a>
                    <button class="btn btn-sm btn-warning" onclick="openEditModal(${r.id})" title="Edit">‚úèÔ∏è</button>
                    ${!(r.isLatest || r.is_latest == 1) ? `<button class="btn btn-sm btn-primary" onclick="setAsLatest(${r.id})" title="Set Latest">‚≠ê</button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteRelease(${r.id})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    function updateStats() {
        const total = releases.length;
        const dl = releases.reduce((s, r) => s + (r.downloads || r.download_count || 0), 0);
        const latest = releases.find(r => r.isLatest || r.is_latest == 1);
        const size = releases.reduce((s, r) => s + (parseInt(r.fileSize || r.file_size) || 0), 0);
        
        document.getElementById('statReleases').textContent = total;
        document.getElementById('statDownloads').textContent = dl;
        document.getElementById('statLatest').textContent = latest ? `v${latest.version}` : '-';
        document.getElementById('statSize').textContent = formatBytesAdmin(size);
    }

    // ============================================
    // Utilities
    // ============================================
    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span> ${message}`;
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 3500);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    async function clearAllData() {
        if (confirm('‚ö†Ô∏è Delete ALL releases?')) {
            showAlert('Use the Database section to manage data', 'error');
        }
    }

    // ============================================
    // DATABASE MANAGEMENT
    // ============================================
    const TABLE_DESCRIPTIONS = {
        roles: 'User role definitions and permissions',
        users: 'Registered user accounts with auth data',
        apk_versions: 'Stores all APK release information',
        download_logs: 'Tracks all APK download attempts',
        contact_messages: 'User contact form submissions',
        email_logs: 'Records all emails sent by the system',
        login_attempts: 'Tracks login attempts for rate limiting',
        audit_logs: 'Records all significant database changes',
        settings: 'Admin-configurable system settings',
        admin_invites: 'Admin invitation tokens and status',
        apk_file_chunks: 'Stored APK file binary chunks'
    };

    async function loadDatabaseStats() {
        try {
            const statsResp = await apiFetch(`${API_BASE}/users.php?action=stats`);
            const stats = await statsResp.json();
            const versResp = await apiFetch(`${API_BASE}/versions.php`);
            const versions = await versResp.json();
            const versionCount = Array.isArray(versions) ? versions.length : 0;
            const msgsResp = await apiFetch(`${API_BASE}/messages.php`);
            const msgs = await msgsResp.json();
            const messageCount = Array.isArray(msgs) ? msgs.length : 0;
            let totalDownloads = 0;
            if (Array.isArray(versions)) versions.forEach(v => { totalDownloads += parseInt(v.download_count || 0); });
            
            document.getElementById('dbVersions').textContent = versionCount;
            document.getElementById('dbUsers').textContent = stats.total_users || 0;
            document.getElementById('dbLogs').textContent = stats.total_downloads || 0;
            document.getElementById('dbMessages').textContent = messageCount;
            document.getElementById('dbTotalDownloads').textContent = totalDownloads;
            
            const el = (id) => document.getElementById(id);
            if (el('dbVersions2')) el('dbVersions2').textContent = versionCount;
            if (el('dbUsers2')) el('dbUsers2').textContent = stats.total_users || 0;
            if (el('dbLogs2')) el('dbLogs2').textContent = stats.total_downloads || 0;
            if (el('dbMessages2')) el('dbMessages2').textContent = messageCount;
            if (el('dbTotalDownloads2')) el('dbTotalDownloads2').textContent = totalDownloads;
        } catch(e) { console.error('Error loading DB stats:', e); }
    }

    async function loadTableStats() {
        const tbody = document.getElementById('dbTablesBody');
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=table-stats`);
            const tables = await resp.json();
            if (Array.isArray(tables) && tables.length > 0) {
                tbody.innerHTML = tables.map(t => {
                    const desc = TABLE_DESCRIPTIONS[t.name] || 'System table';
                    const size = t.data_length > 1024 ? (t.data_length / 1024).toFixed(1) + ' KB' : t.data_length + ' B';
                    return `<tr>
                        <td><span class="table-name" onclick="browseTable('${t.name}')" title="Click to browse">${t.name}</span></td>
                        <td style="color:var(--text-muted);font-size:12px;">${desc}</td>
                        <td><strong>${t.rows}</strong> <span style="color:var(--text-muted);font-size:11px;">(${size})</span></td>
                        <td style="font-size:12px;color:var(--text-muted);">${t.engine || 'InnoDB'}</td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="browseTable('${t.name}')" style="font-size:11px;padding:4px 10px;">üìã Browse</button></td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);">No table info available</td></tr>';
            }
        } catch(e) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--danger);">Failed to load table info</td></tr>';
        }
    }

    async function loadAuditLog() {
        const containers = [document.getElementById('activityEntries'), document.getElementById('activityEntriesDB')];
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=audit-log`);
            const data = await resp.json();
            const html = (Array.isArray(data) && data.length > 0) ? data.slice(0, 25).map(entry => {
                const d = new Date(entry.created_at);
                const time = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const date = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border);">
                    <span style="color:var(--secondary);">[${date} ${time}]</span>
                    <span style="color:var(--primary-light);">${entry.username || 'System'}</span> ‚Äî ${entry.action}
                    ${entry.table_name ? 'on <strong>' + entry.table_name + '</strong>' : ''}
                    ${entry.record_id ? ' (ID: ' + entry.record_id + ')' : ''}
                </div>`;
            }).join('') : '<div style="opacity:.5;">[No recent activity]</div>';
            containers.forEach(c => { if (c) c.innerHTML = html; });
        } catch(e) { containers.forEach(c => { if (c) c.innerHTML = '<div style="opacity:.5;">[Could not load activity]</div>'; }); }
    }

    async function refreshDatabase() {
        showAlert('Refreshing database info...', 'success');
        await Promise.all([loadDatabaseStats(), loadTableStats(), loadAuditLog()]);
        showAlert('Database info refreshed!', 'success');
    }

    async function exportDatabase(mode) {
        if (mode === 'preview') {
            showAlert('‚è≥ Generating SQL preview...', 'success');
            try {
                const r = await apiFetch(`${API_BASE}/backup.php?preview=1`);
                if (r.ok) {
                    const data = await r.json();
                    if (data.success && data.sql) {
                        const w = window.open('', '_blank');
                        w.document.write(`<html><head><title>LokAlert SQL Backup Preview</title><style>body{background:#0c0f1a;color:#e0e0e0;font-family:monospace;padding:20px;white-space:pre-wrap;font-size:13px;line-height:1.6;}</style></head><body>${data.sql.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</body></html>`);
                        w.document.close();
                        showAlert(`‚úÖ SQL preview generated ‚Äî ${data.filename} (${formatBytesAdmin(data.size)})`, 'success');
                    } else {
                        showAlert('‚ùå Preview failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                } else {
                    const errData = await r.json().catch(() => null);
                    showAlert('‚ùå Preview failed: ' + (errData?.error || `Server returned ${r.status}`), 'error');
                }
            } catch(e) { showAlert('‚ùå Network error ‚Äî could not reach backup endpoint', 'error'); }
            return;
        }

        showAlert('‚è≥ Starting backup download...', 'success');
        try {
            const r = await apiFetch(`${API_BASE}/backup.php`);
            if (r.ok) {
                const ct = r.headers.get('Content-Type') || '';
                if (ct.includes('application/sql') || ct.includes('application/octet-stream')) {
                    const blob = await r.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const filename = `lokalert-backup-${new Date().toISOString().split('T')[0]}.sql`;
                    a.href = url; a.download = filename;
                    a.click(); URL.revokeObjectURL(url);
                    showAlert(`‚úÖ Backup downloaded successfully! (${filename}, ${formatBytesAdmin(blob.size)})`, 'success');
                    loadBackupHistory();
                } else {
                    const d = await r.json().catch(() => null);
                    showAlert('‚ùå Backup failed: ' + (d?.error || 'Unexpected response from server'), 'error');
                }
            } else {
                const d = await r.json().catch(() => null);
                showAlert('‚ùå Backup failed: ' + (d?.error || `Server error (HTTP ${r.status})`), 'error');
            }
        } catch(e) { showAlert('‚ùå Network error ‚Äî could not reach backup endpoint. ' + e.message, 'error'); }
    }

    function showBackupInstructions(type) {
        const modal = document.getElementById('backupInstructionsModal');
        const title = document.getElementById('backupInstructionsTitle');
        const body = document.getElementById('backupInstructionsBody');
        if (type === 'import') {
            title.innerHTML = 'üì• Restore / Import';
            body.innerHTML = `<ol style="padding-left:20px;"><li><strong>Export a backup first</strong></li><li>Go to <a href="https://dash.infinityfree.com" target="_blank" style="color:var(--primary);">InfinityFree Dashboard</a> ‚Üí phpMyAdmin</li><li>Select <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px;">if0_41012166_database</code></li><li>Go to the <strong>SQL</strong> tab</li><li>Paste or upload the <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px;">.sql</code> file</li><li>Click <strong>Go</strong></li></ol><div style="margin-top:14px;padding:12px;background:rgba(245,158,11,.08);border-radius:8px;border-left:3px solid var(--warning);"><strong>‚ö†Ô∏è Warning:</strong> Importing may overwrite existing data!</div>`;
        } else if (type === 'rollback') {
            title.innerHTML = '‚è™ Rollback';
            body.innerHTML = `<ol style="padding-left:20px;"><li>Locate your backup <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px;">.sql</code> file</li><li>In phpMyAdmin, select all tables ‚Üí <strong>Drop</strong></li><li>Go to <strong>SQL</strong> tab, upload the backup file, click <strong>Go</strong></li></ol><div style="margin-top:14px;padding:12px;background:rgba(239,68,68,.08);border-radius:8px;border-left:3px solid var(--danger);"><strong>üö® Danger:</strong> Rollback replaces ALL data. Create a fresh backup first.</div>`;
        }
        modal.style.display = 'flex';
    }

    // ============================================
    // TABLE BROWSER
    // ============================================
    async function browseTable(tableName) {
        browserCurrentTable = tableName; browserCurrentPage = 1;
        document.getElementById('browserTableName').textContent = tableName;
        document.getElementById('tableBrowserModal').style.display = 'flex';
        await loadTablePage(tableName, 1);
    }

    async function loadTablePage(tableName, page) {
        browserCurrentPage = page;
        const thead = document.getElementById('browserTableHead');
        const tbody = document.getElementById('browserTableBody');
        const stats = document.getElementById('browserStats');
        tbody.innerHTML = '<tr><td colspan="20" style="text-align:center;color:var(--text-muted);padding:30px;">Loading...</td></tr>';
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=table-data&table=${encodeURIComponent(tableName)}&page=${page}&limit=25`);
            const data = await resp.json();
            if (data.error) { tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;color:var(--danger);">${data.error}</td></tr>`; return; }
            const columns = data.columns || [];
            const colNames = columns.map(c => c.Field || c.field || Object.values(c)[0]);
            thead.innerHTML = '<tr>' + colNames.map(c => `<th style="white-space:nowrap;">${c}</th>`).join('') + '<th style="width:90px;">Actions</th></tr>';
            const rows = data.rows || [];
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + (colNames.length + 1) + '" style="text-align:center;color:var(--text-muted);padding:20px;">No records found</td></tr>';
            } else {
                tbody.innerHTML = rows.map(row => {
                    const pk = row.id || row.ID || Object.values(row)[0];
                    const cells = colNames.map(col => {
                        let v = row[col];
                        if (v === null || v === undefined) return '<td class="data-cell-null">NULL</td>';
                        v = String(v);
                        if (v.length > 80) v = v.substring(0, 80) + '‚Ä¶';
                        if (col.toLowerCase() === 'password') return '<td style="color:var(--text-muted);">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>';
                        if (col === 'chunk_data') return '<td style="color:var(--text-muted);">[BLOB]</td>';
                        return `<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${v.replace(/"/g, '&quot;')}">${v}</td>`;
                    }).join('');
                    const prot = (tableName === 'users' && row.is_admin == 1) || tableName === 'roles' || tableName === 'settings';
                    const isNonEditable = NON_EDITABLE_TABLES.includes(tableName);
                    const delBtn = prot || isNonEditable ? '' : `<button class="btn btn-sm btn-danger" onclick="deleteRecordFromBrowser('${tableName}',${pk})" style="font-size:11px;padding:3px 8px;">üóëÔ∏è</button>`;
                    const editBtn = isNonEditable 
                        ? `<button class="btn btn-sm btn-ghost" onclick="editRecord('${tableName}',${pk})" style="font-size:11px;padding:3px 8px;opacity:.5;" title="Read-only table">üîí</button>`
                        : `<button class="btn btn-sm btn-warning" onclick="editRecord('${tableName}',${pk})" style="font-size:11px;padding:3px 8px;">‚úèÔ∏è</button>`;
                    return `<tr>${cells}<td class="actions" style="white-space:nowrap;">${editBtn}${delBtn}</td></tr>`;
                }).join('');
            }
            const start = (data.page - 1) * data.limit + 1;
            const end = Math.min(data.page * data.limit, data.total);
            stats.textContent = `Showing ${start}‚Äì${end} of ${data.total} records`;
            renderPagination(data.total_pages, data.page);
        } catch(e) { tbody.innerHTML = '<tr><td colspan="20" style="text-align:center;color:var(--danger);">Failed to load data</td></tr>'; }
    }

    function renderPagination(tp, cp) {
        const h = buildPaginationHTML(tp, cp);
        document.getElementById('browserPagination').innerHTML = h;
        document.getElementById('browserPaginationBottom').innerHTML = h;
    }
    function buildPaginationHTML(tp, cp) {
        if (tp <= 1) return '';
        let h = '';
        if (cp > 1) h += `<button onclick="loadTablePage('${browserCurrentTable}',${cp - 1})">‚Üê Prev</button>`;
        const s = Math.max(1, cp - 2), e = Math.min(tp, cp + 2);
        if (s > 1) h += `<button onclick="loadTablePage('${browserCurrentTable}',1)">1</button>`;
        if (s > 2) h += `<span style="color:var(--text-muted);padding:0 4px;">‚Ä¶</span>`;
        for (let i = s; i <= e; i++) {
            const act = i === cp ? 'background:var(--primary);color:#fff;border-color:var(--primary);' : '';
            h += `<button onclick="loadTablePage('${browserCurrentTable}',${i})" style="${act}">${i}</button>`;
        }
        if (e < tp - 1) h += `<span style="color:var(--text-muted);padding:0 4px;">‚Ä¶</span>`;
        if (e < tp) h += `<button onclick="loadTablePage('${browserCurrentTable}',${tp})">${tp}</button>`;
        if (cp < tp) h += `<button onclick="loadTablePage('${browserCurrentTable}',${cp + 1})">Next ‚Üí</button>`;
        return h;
    }
    function refreshBrowserTable() { loadTablePage(browserCurrentTable, browserCurrentPage); }
    function closeBrowserModal() { document.getElementById('tableBrowserModal').style.display = 'none'; }

    // ============================================
    // RECORD EDITING
    // ============================================
    async function editRecord(tableName, recordId) {
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=table-data&table=${encodeURIComponent(tableName)}&page=1&limit=1000`);
            const data = await resp.json();
            const columns = (data.columns || []).map(c => c.Field || c.field || Object.values(c)[0]);
            const row = (data.rows || []).find(r => (r.id || r.ID || Object.values(r)[0]) == recordId);
            if (!row) { showAlert('Record not found', 'error'); return; }
            document.getElementById('editRecordTable').textContent = tableName;
            document.getElementById('editRecordId').textContent = recordId;
            document.getElementById('editRecordFields').innerHTML = columns.map(col => {
                const val = row[col];
                const ro = col === 'id' || col === 'created_at' || col === 'updated_at' || col === 'password' || col === 'chunk_data';
                const dv = col === 'password' ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : col === 'chunk_data' ? '[BLOB]' : (val === null ? '' : val);
                return `<div class="form-group" style="margin-bottom:10px;">
                    <label style="font-size:12px;color:${ro ? 'var(--text-muted)' : 'var(--text)'};">${col}${ro ? ' (read-only)' : ''}</label>
                    <input type="text" name="${col}" value="${String(dv).replace(/"/g, '&quot;')}" ${ro ? 'readonly style="opacity:.5;cursor:not-allowed;"' : ''}>
                </div>`;
            }).join('');
            document.getElementById('editRecordModal').style.display = 'flex';
        } catch(e) { showAlert('Error: ' + e.message, 'error'); }
    }

    async function saveRecordEdit(e) {
        e.preventDefault();
        const table = document.getElementById('editRecordTable').textContent;
        const id = document.getElementById('editRecordId').textContent;
        const formData = {};
        document.querySelectorAll('#editRecordFields input:not([readonly])').forEach(i => { formData[i.name] = i.value; });
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=table-record&table=${encodeURIComponent(table)}&id=${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify(formData)
            });
            const d = await r.json();
            if (d.success) { closeEditRecordModal(); showAlert('Record updated!', 'success'); refreshBrowserTable(); loadAuditLog(); }
            else { showAlert(d.error || 'Failed to update', 'error'); }
        } catch(e) { showAlert('Error: ' + e.message, 'error'); }
    }

    async function deleteRecordFromBrowser(tableName, recordId) {
        if (!confirm(`Delete record #${recordId} from ${tableName}?`)) return;
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=table-record&table=${encodeURIComponent(tableName)}&id=${recordId}`, { method: 'DELETE' });
            const d = await r.json();
            if (d.success) { showAlert('Record deleted!', 'success'); refreshBrowserTable(); loadDatabaseStats(); loadTableStats(); loadAuditLog(); }
            else { showAlert(d.error || 'Failed to delete', 'error'); }
        } catch(e) { showAlert('Error: ' + e.message, 'error'); }
    }
    function closeEditRecordModal() { document.getElementById('editRecordModal').style.display = 'none'; }

    // ============================================
    // ADMIN SETTINGS
    // ============================================
    const SETTING_LABELS = {
        session_timeout_minutes: { label: '‚è±Ô∏è Session Timeout (min)', desc: 'Auto-logout after inactivity', type: 'number', min: 1, max: 120 },
        download_cooldown_minutes: { label: '‚è≥ Download Cooldown (min)', desc: 'Minimum time between downloads', type: 'number', min: 0, max: 60 },
        max_login_attempts: { label: 'üîí Max Login Attempts', desc: 'Failed attempts before lockout', type: 'number', min: 1, max: 20 },
        login_lockout_minutes: { label: 'üîê Lockout Duration (min)', desc: 'How long users are locked out', type: 'number', min: 1, max: 120 },
        site_maintenance_mode: { label: 'üîß Maintenance Mode', desc: 'Restrict public site access', type: 'select', options: { '0': 'Disabled', '1': 'Enabled' } },
        maintenance_message: { label: 'üìù Maintenance Message', desc: 'Message shown on public site during maintenance', type: 'textarea' },
        invite_expiry_hours: { label: '‚úâÔ∏è Invite Expiry (hours)', desc: 'Default admin invite link expiration', type: 'number', min: 1, max: 720 },
        apk_db_storage_enabled: { label: 'üíæ APK DB Storage', desc: 'Allow storing APK files in database', type: 'select', options: { '0': 'Disabled', '1': 'Enabled' } }
    };

    async function loadSettings() {
        const grid = document.getElementById('settingsGrid');
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=settings`);
            const settings = await resp.json();
            if (Array.isArray(settings) && settings.length > 0) {
                grid.innerHTML = settings.map(s => {
                    const m = SETTING_LABELS[s.setting_key] || { label: s.setting_key, desc: s.description || '', type: 'text' };
                    let inp = '';
                    if (m.type === 'select') {
                        inp = `<select id="setting_${s.setting_key}">${Object.entries(m.options).map(([v, l]) => `<option value="${v}" ${s.setting_value == v ? 'selected' : ''}>${l}</option>`).join('')}</select>`;
                    } else if (m.type === 'textarea') {
                        inp = `<textarea id="setting_${s.setting_key}" rows="2">${s.setting_value || ''}</textarea>`;
                    } else {
                        inp = `<input type="${m.type || 'text'}" id="setting_${s.setting_key}" value="${s.setting_value || ''}" ${m.min !== undefined ? 'min="' + m.min + '"' : ''} ${m.max !== undefined ? 'max="' + m.max + '"' : ''}>`;
                    }
                    return `<div class="setting-item">
                        <div style="margin-bottom:6px;"><strong style="font-size:13px;">${m.label}</strong><div style="font-size:11px;color:var(--text-muted);">${m.desc}</div></div>
                        ${inp}
                    </div>`;
                }).join('');
                const ts = settings.find(s => s.setting_key === 'session_timeout_minutes');
                if (ts) sessionTimeoutMinutes = parseInt(ts.setting_value) || 5;
                
                // Update DB upload status
                const dbStorage = settings.find(s => s.setting_key === 'apk_db_storage_enabled');
                const statusEl = document.getElementById('dbUploadStatus');
                if (dbStorage && dbStorage.setting_value === '1') {
                    statusEl.style.borderLeftColor = 'var(--success)';
                    statusEl.style.background = 'rgba(34,197,94,.08)';
                    statusEl.style.color = 'var(--success)';
                    statusEl.innerHTML = '‚úÖ APK Database Storage is enabled. You can upload APKs directly to the database.';
                }
            }
        } catch(e) { grid.innerHTML = '<div style="color:var(--danger);grid-column:1/-1;">Failed to load settings</div>'; }
    }

    async function saveSettings() {
        const btn = document.getElementById('saveSettingsBtn');
        btn.disabled = true; btn.textContent = 'Saving...';
        const payload = {};
        document.querySelectorAll('#settingsGrid input, #settingsGrid select, #settingsGrid textarea').forEach(el => {
            payload[el.id.replace('setting_', '')] = el.value;
        });
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=settings`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify(payload)
            });
            const d = await r.json();
            if (d.success) {
                showAlert('Settings saved successfully!', 'success');
                if (payload.session_timeout_minutes) { sessionTimeoutMinutes = parseInt(payload.session_timeout_minutes); sessionSecondsLeft = sessionTimeoutMinutes * 60; }
                loadAuditLog();
                checkMaintenanceStatus();
            } else { showAlert(d.error || 'Failed to save settings', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
        finally { btn.disabled = false; btn.textContent = 'üíæ Save All'; }
    }

    // ============================================
    // MESSAGES / INQUIRIES MANAGEMENT
    // ============================================
    let messagesData = [];
    let msgFilter = 'all'; // 'all', 'unread', 'read'

    function toggleMsgFilter() {
        const btn = document.getElementById('msgFilterBtn');
        if (msgFilter === 'all') { msgFilter = 'unread'; btn.textContent = 'üîî Unread'; }
        else if (msgFilter === 'unread') { msgFilter = 'read'; btn.textContent = 'üìñ Read'; }
        else { msgFilter = 'all'; btn.textContent = 'üìã All'; }
        renderMessagesTable();
    }

    async function loadMessages() {
        const tbody = document.getElementById('messagesTable');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:20px;">Loading messages...</td></tr>';
        try {
            const resp = await apiFetch(`${API_BASE}/messages.php`);
            messagesData = await resp.json();
            if (!Array.isArray(messagesData)) messagesData = [];

            const total = messagesData.length;
            const unread = messagesData.filter(m => !m.is_read).length;
            const read = total - unread;

            document.getElementById('statMsgTotal').textContent = total;
            document.getElementById('statMsgRead').textContent = read;
            document.getElementById('statMsgUnread').textContent = unread;

            // Update badge in sidebar
            const badge = document.getElementById('msgBadge');
            if (badge) {
                if (unread > 0) { badge.textContent = unread; badge.style.display = 'inline'; }
                else { badge.style.display = 'none'; }
            }

            renderMessagesTable();
        } catch(e) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--danger);">Failed to load messages</td></tr>';
        }
    }

    function renderMessagesTable() {
        const tbody = document.getElementById('messagesTable');
        let filtered = messagesData;
        if (msgFilter === 'unread') filtered = messagesData.filter(m => !m.is_read);
        else if (msgFilter === 'read') filtered = messagesData.filter(m => m.is_read);

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:20px;">${msgFilter === 'all' ? 'No messages yet' : 'No ' + msgFilter + ' messages'}</td></tr>`;
            return;
        }

        tbody.innerHTML = filtered.map((m, i) => {
            const statusBadge = m.is_read
                ? '<span class="badge badge-success">Read</span>'
                : '<span class="badge badge-warning">Unread</span>';
            const msgPreview = m.message.length > 60 ? m.message.substring(0, 60) + '‚Ä¶' : m.message;
            const rowStyle = m.is_read ? '' : 'background:rgba(99,102,241,.04);';
            return `<tr style="${rowStyle}">
                <td>${m.id}</td>
                <td><strong>${m.name}</strong></td>
                <td><a href="mailto:${m.email}" style="color:var(--primary-light);text-decoration:none;">${m.email}</a></td>
                <td>${m.subject}</td>
                <td title="${m.message.replace(/"/g, '&quot;')}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${msgPreview}</td>
                <td>${statusBadge}</td>
                <td style="font-size:12px;white-space:nowrap;">${formatDate(m.created_at)}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-primary" onclick="viewMessage(${m.id})" title="View" style="font-size:11px;padding:3px 8px;">üëÅÔ∏è</button>
                    <button class="btn btn-sm ${m.is_read ? 'btn-ghost' : 'btn-success'}" onclick="toggleMessageRead(${m.id}, ${m.is_read ? 0 : 1})" title="${m.is_read ? 'Mark Unread' : 'Mark Read'}" style="font-size:11px;padding:3px 8px;">${m.is_read ? 'üì©' : '‚úÖ'}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMessage(${m.id})" title="Delete" style="font-size:11px;padding:3px 8px;">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    async function viewMessage(id) {
        try {
            const resp = await apiFetch(`${API_BASE}/messages.php?id=${id}`);
            const msg = await resp.json();
            if (msg.error) { showAlert(msg.error, 'error'); return; }

            const modal = document.getElementById('backupInstructionsModal');
            const title = document.getElementById('backupInstructionsTitle');
            const body = document.getElementById('backupInstructionsBody');
            title.innerHTML = 'üì¨ Message from ' + msg.name;
            body.innerHTML = `
                <div style="margin-bottom:14px;">
                    <div style="display:grid;grid-template-columns:80px 1fr;gap:6px;font-size:13px;">
                        <strong style="color:var(--text-muted);">From:</strong><span>${msg.name} &lt;${msg.email}&gt;</span>
                        <strong style="color:var(--text-muted);">Subject:</strong><span>${msg.subject}</span>
                        <strong style="color:var(--text-muted);">Date:</strong><span>${new Date(msg.created_at).toLocaleString()}</span>
                        <strong style="color:var(--text-muted);">Status:</strong><span>${msg.is_read ? '‚úÖ Read' : 'üîî Unread'}</span>
                    </div>
                </div>
                <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:10px;padding:16px;font-size:14px;line-height:1.7;white-space:pre-wrap;">${msg.message}</div>
                <div style="margin-top:14px;display:flex;gap:8px;">
                    <a href="mailto:${msg.email}?subject=Re: ${encodeURIComponent(msg.subject)}" class="btn btn-primary" style="font-size:13px;padding:8px 16px;border-radius:8px;text-decoration:none;">üìß Reply via Email</a>
                </div>`;
            modal.style.display = 'flex';
            // Refresh to update read status
            loadMessages();
        } catch(e) { showAlert('Error loading message: ' + e.message, 'error'); }
    }

    async function toggleMessageRead(id, isRead) {
        try {
            const r = await apiFetch(`${API_BASE}/messages.php?id=${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ is_read: isRead })
            });
            const d = await r.json();
            if (d.success) { showAlert(isRead ? '‚úÖ Marked as read' : 'üì© Marked as unread', 'success'); loadMessages(); }
            else { showAlert(d.error || 'Failed to update', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    async function deleteMessage(id) {
        if (!confirm('Delete this message permanently?')) return;
        try {
            const r = await apiFetch(`${API_BASE}/messages.php?id=${id}`, { method: 'DELETE' });
            const d = await r.json();
            if (d.success) { showAlert('üóëÔ∏è Message deleted', 'success'); loadMessages(); }
            else { showAlert(d.error || 'Failed to delete', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    // ============================================
    // BACKUP MANAGEMENT
    // ============================================
    async function loadBackupHistory() {
        const tbody = document.getElementById('backupHistoryBody');
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=backup-history`);
            const data = await resp.json();
            if (Array.isArray(data) && data.length > 0) {
                tbody.innerHTML = data.map((b, i) => `<tr><td>${i + 1}</td><td>${b.username || 'Admin'}</td><td>${new Date(b.created_at).toLocaleString()}</td><td style="font-family:monospace;font-size:11px;">${b.ip_address || '‚Äî'}</td></tr>`).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No backups recorded yet</td></tr>';
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--danger);">Failed to load</td></tr>'; }
    }

    // ============================================
    // ADMIN INVITE MANAGEMENT
    // ============================================
    async function submitAdminInvite(e) {
        e.preventDefault();
        const name = document.getElementById('inviteAdminName').value.trim();
        const email = document.getElementById('inviteAdminEmail').value.trim();
        const password = document.getElementById('inviteAdminPassword').value;
        const expiry = parseInt(document.getElementById('inviteAdminExpiry').value) || 48;
        const result = document.getElementById('inviteResult');
        
        if (!email) { showAlert('Email is required', 'error'); return; }
        
        result.innerHTML = '<p style="color:var(--text-muted);">Sending invitation...</p>';
        
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=invite-admin`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ name, email, password, expiry_hours: expiry })
            });
            const d = await r.json();
            if (d.success) {
                showAlert('‚úÖ Invitation created!', 'success');
                result.innerHTML = `<div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:16px;">
                    <p style="color:var(--success);font-weight:600;margin-bottom:8px;">‚úÖ Invitation Created!</p>
                    <p style="font-size:13px;color:var(--text-muted);margin-bottom:6px;">Email sent: ${d.email_sent ? 'Yes ‚úâÔ∏è' : 'No (share link manually)'}</p>
                    <p style="font-size:12px;color:var(--text-muted);">Invite link (click to copy):</p>
                    <div class="invite-link-box" onclick="navigator.clipboard.writeText(this.textContent);showAlert('Copied!','success');">${d.invite_link}</div>
                    <p style="font-size:11px;color:var(--text-muted);margin-top:8px;">Expires: ${d.expires_at}</p>
                </div>`;
                document.getElementById('inviteAdminForm').reset();
                document.getElementById('inviteAdminExpiry').value = '48';
                loadInvites();
            } else {
                result.innerHTML = `<p style="color:var(--danger);">‚ùå ${d.error || 'Failed to create invitation'}</p>`;
            }
        } catch(err) {
            result.innerHTML = '<p style="color:var(--danger);">‚ùå Network error</p>';
        }
    }

    async function loadInvites() {
        const tbody = document.getElementById('invitesTable');
        try {
            const resp = await apiFetch(`${API_BASE}/users.php?action=list-invites`);
            const data = await resp.json();
            if (Array.isArray(data) && data.length > 0) {
                tbody.innerHTML = data.map(inv => {
                    const statusBadge = {
                        pending: '<span class="badge badge-warning">‚è≥ Pending</span>',
                        accepted: '<span class="badge badge-success">‚úÖ Accepted</span>',
                        expired: '<span class="badge badge-danger">‚è∞ Expired</span>',
                        invalidated: '<span class="badge badge-danger">üö´ Revoked</span>'
                    }[inv.status] || inv.status;
                    const actions = inv.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="invalidateInvite(${inv.id})">üö´ Revoke</button>` : '‚Äî';
                    return `<tr>
                        <td>${inv.name || '‚Äî'}</td>
                        <td>${inv.email}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(inv.created_at)}</td>
                        <td>${formatDate(inv.expires_at)}</td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);">No invitations yet</td></tr>';
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--danger);">Failed to load invites</td></tr>'; }
    }

    async function invalidateInvite(inviteId) {
        if (!confirm('Revoke this invitation?')) return;
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=invalidate-invite`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ invite_id: inviteId })
            });
            const d = await r.json();
            if (d.success) { showAlert('Invitation revoked!', 'success'); loadInvites(); }
            else { showAlert(d.error || 'Failed', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    // ============================================
    // PROMOTE / DEMOTE ADMIN
    // ============================================
    async function promoteUser(userId, displayName) {
        if (!confirm(`Promote "${displayName}" to Admin?\n\nThis will give them full admin access.`)) return;
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=promote-admin`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ user_id: userId })
            });
            const d = await r.json();
            if (d.success) {
                showAlert('‚úÖ User promoted to admin!', 'success');
                loadUsers();
                loadAdminUsers();
            } else { showAlert(d.error || 'Failed to promote', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    async function demoteUser(userId, displayName) {
        if (!confirm(`Demote "${displayName}" from Admin?\n\nThey will lose all admin access.`)) return;
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=demote-admin`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ user_id: userId })
            });
            const d = await r.json();
            if (d.success) {
                showAlert('‚úÖ User demoted from admin!', 'success');
                loadUsers();
                loadAdminUsers();
            } else { showAlert(d.error || 'Failed to demote', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    async function loadAdminUsers() {
        const tbody = document.getElementById('adminUsersTable');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Loading...</td></tr>';
        try {
            const r = await apiFetch(`${API_BASE}/users.php`);
            const all = await r.json();
            if (Array.isArray(all)) {
                const admins = all.filter(u => u.is_admin);
                if (admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">No admin users found</td></tr>';
                    return;
                }
                tbody.innerHTML = admins.map(u => {
                    const isSelf = currentUser && currentUser.id === u.id;
                    return `<tr>
                        <td>${u.id}</td>
                        <td>${u.username || '<span style="color:var(--text-muted);">‚Äî</span>'} ${isSelf ? '<span class="badge badge-primary">You</span>' : ''}</td>
                        <td>${u.email}</td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>${isSelf ? '<span style="color:var(--text-muted);font-size:12px;">‚Äî</span>' : `<button class="btn btn-sm btn-warning" onclick="demoteUser(${u.id},'${(u.username||u.email).replace(/'/g,"\\\'")}')" title="Demote to Regular User">‚¨áÔ∏è Demote</button>`}</td>
                    </tr>`;
                }).join('');
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--danger);">Failed to load</td></tr>'; }
    }

    // ============================================
    // SESSION TIMER
    // ============================================
    function startSessionTimer() {
        sessionSecondsLeft = sessionTimeoutMinutes * 60;
        const resetTimer = () => {
            sessionSecondsLeft = sessionTimeoutMinutes * 60;
            const el = document.getElementById('sessionTimer');
            if (el) el.classList.remove('warning', 'danger');
        };
        ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart', 'click'].forEach(ev => {
            document.addEventListener(ev, resetTimer, { passive: true });
        });
        if (sessionTimerInterval) clearInterval(sessionTimerInterval);
        sessionTimerInterval = setInterval(() => {
            sessionSecondsLeft--;
            const m = Math.floor(sessionSecondsLeft / 60);
            const s = sessionSecondsLeft % 60;
            const display = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            const cdEl = document.getElementById('sessionCountdown');
            const tEl = document.getElementById('sessionTimer');
            if (cdEl) cdEl.textContent = display;
            if (tEl) {
                tEl.classList.remove('warning', 'danger');
                if (sessionSecondsLeft <= 30) tEl.classList.add('danger');
                else if (sessionSecondsLeft <= 60) tEl.classList.add('warning');
            }
            if (sessionSecondsLeft <= 0) { clearInterval(sessionTimerInterval); handleSessionTimeout(); }
        }, 1000);
    }

    async function handleSessionTimeout() {
        try { await apiFetch(`${API_BASE}/auth.php?action=logout`, { method: 'POST' }); } catch(e) {}
        isLoggedIn = false;
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('loginContainer').classList.remove('hidden');
        const err = document.getElementById('loginError');
        if (err) { err.textContent = '‚è±Ô∏è Session expired due to inactivity. Please log in again.'; err.style.display = 'block'; }
    }

    // ============================================
    // USER MANAGEMENT
    // ============================================
    let usersData = [];

    async function loadUsers() {
        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Loading...</td></tr>';
        try {
            const statsR = await apiFetch(`${API_BASE}/users.php?action=stats`);
            const stats = await statsR.json();
            if (stats.total_users !== undefined) {
                document.getElementById('statTotalUsers').textContent = stats.total_users;
                if (document.getElementById('statTotalUsers2')) document.getElementById('statTotalUsers2').textContent = stats.total_users;
                document.getElementById('statVerifiedUsers').textContent = stats.verified_users;
                document.getElementById('statUsersWithNames').textContent = stats.users_with_names;
                document.getElementById('statUsersDownloaded').textContent = stats.users_with_downloads;
                document.getElementById('dbUsers').textContent = stats.total_users + 1;
            }
            const usersR = await apiFetch(`${API_BASE}/users.php`);
            usersData = await usersR.json();
            if (Array.isArray(usersData) && usersData.length > 0) {
                const regular = usersData.filter(u => !u.is_admin);
                if (regular.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:20px;">No regular users registered yet</td></tr>'; return; }
                tbody.innerHTML = regular.map(u => `<tr>
                    <td>${u.id}</td>
                    <td>${u.username || '<span style="color:var(--text-muted);">‚Äî</span>'}</td>
                    <td>${u.email}</td>
                    <td>${u.is_verified ? '<span class="badge badge-success">‚úì Yes</span>' : '<span class="badge badge-warning">Pending</span>'}</td>
                    <td>${u.download_count || 0}</td>
                    <td>${formatDate(u.created_at)}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-success" onclick="promoteUser(${u.id},'${(u.username||u.email).replace(/'/g,"\\'")  }')" title="Promote to Admin">üõ°Ô∏è</button>
                        <button class="btn btn-sm btn-warning" onclick="openUserEditModal(${u.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-primary" onclick="openPasswordResetModal(${u.id},'${u.email}')" title="Reset Password">üîê</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`).join('');
            } else if (usersData.error) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--danger);">${usersData.error}</td></tr>`;
            } else { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:20px;">No users registered yet</td></tr>'; }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--danger);">Failed to load users</td></tr>'; }
    }

    function openUserEditModal(userId) {
        const u = usersData.find(x => x.id === userId);
        if (u) {
            document.getElementById('userEditId').value = u.id;
            document.getElementById('userEditName').value = u.username || '';
            document.getElementById('userEditEmail').value = u.email;
            document.getElementById('userEditModal').classList.add('active');
        }
    }
    function closeUserEditModal() { document.getElementById('userEditModal').classList.remove('active'); }

    async function saveUserEdit(e) {
        e.preventDefault();
        const id = document.getElementById('userEditId').value;
        const name = document.getElementById('userEditName').value.trim();
        const email = document.getElementById('userEditEmail').value.trim();
        try {
            const r = await apiFetch(`${API_BASE}/users.php?id=${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ username: name, email })
            });
            const d = await r.json();
            if (d.success) { closeUserEditModal(); loadUsers(); showAlert('User updated!', 'success'); }
            else { showAlert(d.error || 'Failed to update user', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    async function deleteUser(userId) {
        if (!confirm('Delete this user permanently?')) return;
        try {
            const r = await apiFetch(`${API_BASE}/users.php?id=${userId}`, { method: 'DELETE' });
            const d = await r.json();
            if (d.success) { loadUsers(); showAlert('User deleted!', 'success'); }
            else { showAlert(d.error || 'Failed to delete', 'error'); }
        } catch(e) { showAlert('Network error', 'error'); }
    }

    function openPasswordResetModal(userId, email) {
        document.getElementById('resetUserId').value = userId;
        document.getElementById('resetUserEmail').textContent = email;
        document.getElementById('tempPassword').value = '';
        document.getElementById('resetResult').innerHTML = '';
        document.getElementById('passwordResetModal').classList.add('active');
    }
    function closePasswordResetModal() { document.getElementById('passwordResetModal').classList.remove('active'); }

    async function sendResetEmail() {
        const userId = document.getElementById('resetUserId').value;
        const el = document.getElementById('resetResult');
        el.innerHTML = '<p style="color:var(--text-muted);">Sending reset email...</p>';
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=send-reset-email`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ user_id: parseInt(userId) })
            });
            const d = await r.json();
            if (d.success) {
                el.innerHTML = '<p style="color:var(--success);">‚úÖ Reset email sent!</p>';
                if (d.debug_token) el.innerHTML += `<p style="color:var(--warning);font-size:11px;word-break:break-all;">Debug token: ${d.debug_token}</p>`;
            } else { el.innerHTML = `<p style="color:var(--danger);">‚ùå ${d.error || 'Failed'}</p>`; }
        } catch(e) { el.innerHTML = '<p style="color:var(--danger);">‚ùå Network error</p>'; }
    }

    async function setTempPassword() {
        const userId = document.getElementById('resetUserId').value;
        const pw = document.getElementById('tempPassword').value.trim();
        const el = document.getElementById('resetResult');
        if (pw && pw.length < 6) { el.innerHTML = '<p style="color:var(--danger);">Password must be at least 6 characters</p>'; return; }
        el.innerHTML = '<p style="color:var(--text-muted);">Setting password...</p>';
        try {
            const r = await apiFetch(`${API_BASE}/users.php?action=reset-password`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },                 body: JSON.stringify({ user_id: parseInt(userId), new_password: pw || '', send_email: true })
            });
            const d = await r.json();
            if (d.success) {
                el.innerHTML = `<p style="color:var(--success);">‚úÖ Password reset!</p>`;
                if (d.temp_password) el.innerHTML += `<p style="color:var(--warning);font-family:monospace;">Temp password: <strong>${d.temp_password}</strong></p>`;
            } else { el.innerHTML = `<p style="color:var(--danger);">‚ùå ${d.error || 'Failed'}</p>`; }
        } catch(e) { el.innerHTML = '<p style="color:var(--danger);">‚ùå Network error</p>'; }
    }

    // ============================================
    // Modal Outside-Click Handlers
    // ============================================
    ['editModal', 'userEditModal', 'passwordResetModal', 'tableBrowserModal', 'editRecordModal', 'backupInstructionsModal'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', function(e) {
            if (e.target === this) {
                if (id === 'editModal') closeEditModal();
                else if (id === 'userEditModal') closeUserEditModal();
                else if (id === 'passwordResetModal') closePasswordResetModal();
                else if (id === 'tableBrowserModal') closeBrowserModal();
                else if (id === 'editRecordModal') closeEditRecordModal();
                else this.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
